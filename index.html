<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Quick Wrap - Simple P2P Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Exo+2:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="phoneData.js"></script>
    <script src="auth.js"></script>
    <style>
        body {
            margin: 0;
            font-family: 'Exo 2', sans-serif;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            background-attachment: fixed;
            color: #fff;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 20% 40%, rgba(124, 58, 237, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 80% 20%, rgba(236, 72, 153, 0.1), transparent),
                radial-gradient(ellipse 50% 30% at 50% 80%, rgba(6, 182, 212, 0.08), transparent);
            pointer-events: none;
            z-index: 0;
        }
        #intro {
            text-align: center;
            animation: fadeIn 1s ease-in;
            padding: 30px;
            background: linear-gradient(145deg, rgba(15, 12, 41, 0.9) 0%, rgba(48, 43, 99, 0.85) 50%, rgba(36, 36, 62, 0.9) 100%);
            border-radius: 24px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(124, 58, 237, 0.2);
            max-width: 920px;
            box-shadow: 
                0 25px 80px rgba(0, 0, 0, 0.5),
                0 0 100px rgba(124, 58, 237, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            position: relative;
            z-index: 1;
        }
        .intro-main {
            display: flex;
            gap: 20px;
            margin-top: 18px;
            align-items: flex-start;
            justify-content: center;
        }
        .intro-left,
        .intro-right {
            flex: 1;
            min-width: 320px;
            display: flex;
        }
        .intro-left {
            align-self: flex-start;
        }
        /* Hide download section in desktop app */
        .is-desktop-app .intro-left,
        .is-desktop-app .download-section {
            display: none !important;
        }
        .is-desktop-app .intro-main {
            justify-content: center;
        }
        .is-desktop-app .intro-right {
            flex: none;
            max-width: 400px;
        }

        @media (max-width: 768px) {
            #intro {
                max-width: 400px;
            }
            .intro-main {
                flex-direction: column;
                gap: 16px;
            }
            .intro-left,
            .intro-right {
                min-width: 0;
            }
        }
        #intro h1 {
            font-size: clamp(1.5rem, 5vw, 2.5rem);
            margin: 0;
            background: linear-gradient(135deg, #a78bfa 0%, #ec4899 50%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 2px 10px rgba(167, 139, 250, 0.3));
        }
        .intro-logo {
            width: 120px;
            height: auto;
            margin: 0 auto 12px;
            display: block;
            filter: drop-shadow(0 6px 16px rgba(0, 0, 0, 0.35));
        }
        .privacy-badge {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 20px;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(6, 182, 212, 0.1) 100%);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 30px;
            font-size: 0.85rem;
            color: #10b981;
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.15);
        }
        .privacy-badge svg {
            stroke: #10b981;
            flex-shrink: 0;
        }
        .intro-panel {
            width: 100%;
            padding: 24px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 18px;
            box-shadow: 
                0 10px 40px rgba(0, 0, 0, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.05);
            box-sizing: border-box;
        }
        /* Download Section */
        .download-section {
            margin-top: 0;
            background: linear-gradient(145deg, rgba(124, 58, 237, 0.15) 0%, rgba(236, 72, 153, 0.1) 50%, rgba(251, 146, 60, 0.08) 100%);
            border: 1px solid rgba(124, 58, 237, 0.3);
            position: relative;
            overflow: hidden;
        }
        .download-section::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(124, 58, 237, 0.1), transparent 30%);
            animation: shimmer 8s linear infinite;
            pointer-events: none;
        }
        @keyframes shimmer {
            to { transform: rotate(360deg); }
        }
        .download-section > * {
            position: relative;
            z-index: 1;
        }
        .download-section h3 {
            margin: 0 0 16px 0;
            font-size: 0.85rem;
            font-weight: 600;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .download-section h3 svg {
            stroke: #a78bfa;
        }
        .download-btn {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px 24px;
            width: 100%;
            box-sizing: border-box;
            justify-content: center;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #ec4899 100%);
            background-size: 200% 200%;
            animation: gradientFlow 4s ease infinite;
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            text-decoration: none;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.4), 0 0 40px rgba(124, 58, 237, 0.1);
            position: relative;
            overflow: hidden;
        }
        @keyframes gradientFlow {
            0%, 100% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
        }
        .download-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }
        .download-btn:hover::before {
            left: 100%;
        }
        .download-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 8px 30px rgba(124, 58, 237, 0.5), 0 0 60px rgba(168, 85, 247, 0.2);
        }
        .download-btn:active {
            transform: translateY(-1px) scale(0.98);
        }
        .download-btn svg {
            flex-shrink: 0;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        .download-btn .btn-text {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
        }
        .download-btn .btn-label {
            font-size: 0.7rem;
            font-weight: 500;
            opacity: 0.85;
            letter-spacing: 0.3px;
        }
        .download-btn .btn-platform {
            font-size: 1.05rem;
            font-weight: 700;
        }
        .download-info {
            margin-top: 14px;
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.45);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        .download-info span {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .download-info svg {
            width: 12px;
            height: 12px;
            stroke: rgba(255, 255, 255, 0.4);
        }
        #authForms {
            text-align: left;
        }
        #authForms .auth-form {
            margin-top: 20px;
        }
        #authForms h2 {
            margin-top: 0;
            text-align: center;
        }
        #chatPage {
            display: none;
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            background: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            overflow: hidden;
        }
        .chat-container {
            display: flex;
            height: calc(100% - 60px);
            margin-top: 60px;
        }
        #dashboardHeader {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(90deg, rgba(15, 12, 41, 0.95) 0%, rgba(48, 43, 99, 0.9) 50%, rgba(36, 36, 62, 0.95) 100%);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 100;
            border-bottom: 1px solid rgba(124, 58, 237, 0.2);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        #userInfo {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        #userAvatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #ec4899 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 10px rgba(124, 58, 237, 0.4);
        }
        #userName {
            font-size: 1.1rem;
            color: #fff;
        }
        #signOutBtn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        #signOutBtn:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        #sidebar {
            width: 300px;
            height: 100%;
            background: linear-gradient(180deg, rgba(15, 12, 41, 0.95) 0%, rgba(36, 36, 62, 0.9) 100%);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-sizing: border-box;
            overflow-y: auto;
            transition: all 0.3s ease;
            border-right: 1px solid rgba(124, 58, 237, 0.15);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
            z-index: 10;
        }
        .chat-list {
            margin-top: 20px;
        }
        .chat-list h3 {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.7);
            margin: 0 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-list h3 button {
            background: rgba(124, 58, 237, 0.2);
            border: 1px solid rgba(124, 58, 237, 0.3);
            color: #a78bfa;
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        .chat-list h3 button:hover {
            background: rgba(124, 58, 237, 0.3);
        }
        .chat-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 5px;
        }
        .chat-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-item.active {
            background: rgba(124, 58, 237, 0.2);
            border-left: 3px solid #a78bfa;
        }
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        }
        .chat-details {
            flex: 1;
            overflow: hidden;
        }
        .chat-name {
            font-weight: bold;
            margin-bottom: 3px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .chat-preview {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        #sidebarToggle {
            display: none;
            position: fixed;
            top: 70px;
            left: 10px;
            z-index: 1000;
            background: rgba(15, 12, 41, 0.9);
            border: 1px solid rgba(124, 58, 237, 0.3);
            color: #fff;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(10px);
        }
        /* Sidebar overlay for mobile */
        #sidebarOverlay {
            display: none;
            position: fixed;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #sidebarOverlay.active {
            display: block;
            opacity: 1;
        }
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: 0;
                top: 60px;
                height: calc(100% - 60px);
                backdrop-filter: blur(10px);
                width: 80%;
                max-width: 300px;
                z-index: 1000;
                transform: translateX(calc(-100% - 1px));
                transition: transform 0.3s ease;
            }
            #sidebar.active {
                transform: translateX(0);
                box-shadow: 0 0 30px rgba(124, 58, 237, 0.3);
            }
            #sidebarToggle {
                display: block;
                position: fixed;
                top: 70px;
                left: 10px;
                z-index: 1000;
                background: rgba(15, 12, 41, 0.9);
                border: 1px solid rgba(124, 58, 237, 0.3);
                color: #fff;
                padding: 8px;
                border-radius: 5px;
                cursor: pointer;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
            }
            .chat-container {
                margin-left: 0;
            }
            #chatWindow {
                padding-left: 10px;
                padding-right: 10px;
            }
            #messageControls {
                padding: 10px;
            }
            #messageInput {
                padding: 12px;
            }
            .message {
                max-width: 90%;
            }
            #dashboardHeader {
                padding: 0 15px;
            }
        }
        .connection-setup {
            padding: 20px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.12) 0%, rgba(168, 85, 247, 0.08) 100%);
            border-radius: 16px;
            margin-bottom: 15px;
            border: 1px solid rgba(124, 58, 237, 0.25);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        .connection-setup h3 {
            margin: 0 0 18px;
            color: #fff;
            font-size: 1.1rem;
            text-align: center;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .connection-setup h3::before {
            content: '';
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, #a78bfa, #ec4899);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(167, 139, 250, 0.5);
        }
        .setup-options {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .option-card {
            background: rgba(0, 0, 0, 0.25);
            padding: 15px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .option-card h4 {
            margin: 0 0 10px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 1rem;
        }
        .code-display {
            margin: 10px 0;
            padding: 12px;
            background: rgba(15, 12, 41, 0.6);
            border: 1px solid rgba(124, 58, 237, 0.2);
            border-radius: 10px;
            font-family: monospace;
            font-size: 1.5rem;
            color: #a78bfa;
            text-align: center;
            letter-spacing: 3px;
            text-shadow: 0 0 10px rgba(167, 139, 250, 0.5);
        }
        #sidebar .status-box {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1) 0%, rgba(168, 85, 247, 0.05) 100%);
            padding: 15px;
            border-radius: 12px;
            margin-top: 15px;
            border: 1px solid rgba(124, 58, 237, 0.2);
        }
        #onlineStatus {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        #onlineStatus::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f66;
            transition: background 0.3s ease;
        }
        #onlineStatus.online::before {
            background: #0f0;
        }
        #chatWindow {
            flex: 1;
            background: linear-gradient(180deg, rgba(15, 12, 41, 0.4) 0%, rgba(36, 36, 62, 0.3) 100%);
            padding: 20px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        .chat-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 15px 20px;
            background: linear-gradient(90deg, rgba(15, 12, 41, 0.95) 0%, rgba(48, 43, 99, 0.9) 100%);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(124, 58, 237, 0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 10;
        }
        .chat-header .peer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(124, 58, 237, 0.3);
        }
        .chat-header .peer-info {
            flex: 1;
        }
        .chat-header .peer-name {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 2px;
        }
        .chat-header .peer-status {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .chat-header .actions {
            display: flex;
            gap: 10px;
        }
        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 70px 10px 10px;
            margin: -10px;
            scroll-behavior: smooth;
        }
        .message {
            position: relative;
            margin: 10px 0;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            max-width: 75%;
            width: fit-content;
            word-wrap: break-word;
            animation: messageIn 0.3s ease;
        }
        .system-alert {
            text-align: center;
            color: rgba(0, 194, 255, 0.9);
            font-style: italic;
            padding: 8px 16px;
            margin: 10px auto;
            border-radius: 20px;
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid rgba(0, 194, 255, 0.2);
            font-size: 0.85rem;
            width: fit-content;
            max-width: 90%;
        }
        .message.system-message {
            max-width: 100%;
            width: 100%;
            background: transparent;
            padding: 0;
            margin: 5px 0;
        }
        .message.your-message {
            margin-left: auto;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.6) 0%, rgba(124, 58, 237, 0.4) 100%);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 18px 18px 4px 18px;
        }
        .message.friend-message {
            margin-right: auto;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 18px 18px 18px 4px;
        }
        .message.sent {
            margin-left: auto;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.6) 0%, rgba(124, 58, 237, 0.4) 100%);
            border: 1px solid rgba(124, 58, 237, 0.3);
        }
        .message.received {
            margin-right: auto;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .message .time {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 4px;
        }
        .message .status {
            position: absolute;
            right: 4px;
            bottom: 4px;
            font-size: 0.8rem;
            color: rgba(167, 139, 250, 0.8);
        }
        .auth-form {
            display: flex;
            flex-direction: column;
            gap: 16px;
            margin-top: 20px;
        }
        .auth-form h2 {
            background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.5rem;
            margin-bottom: 8px;
        }
        .auth-form input {
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid rgba(124, 58, 237, 0.2);
            background: rgba(15, 12, 41, 0.6);
            color: white;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        .auth-form input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        .auth-form input:focus {
            outline: none;
            border-color: #a78bfa;
            background: rgba(124, 58, 237, 0.1);
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.2);
        }
        .auth-form button {
            padding: 14px 24px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 50%, #ec4899 100%);
            background-size: 200% 200%;
            animation: gradientFlow 4s ease infinite;
            color: white;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.3);
        }
        .auth-form button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 30px rgba(124, 58, 237, 0.4);
        }
        .auth-form a {
            color: #a78bfa;
            text-decoration: none;
            transition: color 0.3s ease;
        }
        .auth-form a:hover {
            color: #ec4899;
            text-decoration: underline;
        }
        .auth-form p {
            text-align: center;
            color: rgba(255, 255, 255, 0.6);
            margin: 0;
        }
        .phone-selection {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .phone-selection label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .phone-selection select {
            padding: 14px 16px;
            border-radius: 12px;
            border: 1px solid rgba(124, 58, 237, 0.2);
            background: rgba(15, 12, 41, 0.6);
            color: white;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .phone-selection select:focus {
            outline: none;
            border-color: #a78bfa;
            box-shadow: 0 0 20px rgba(124, 58, 237, 0.2);
        }
        .phone-selection select option {
            background: #0f0c29;
            color: white;
        }
        .phone-selection select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .my-number-display {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15) 0%, rgba(168, 85, 247, 0.1) 100%);
            border: 1px solid rgba(124, 58, 237, 0.25);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 15px;
            text-align: center;
        }
        .my-number-display label {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            display: block;
            margin-bottom: 5px;
        }
        .my-number-display .number {
            font-size: 1.1rem;
            color: #a78bfa;
            font-weight: bold;
            letter-spacing: 1px;
        }
        #codeInput {
            width: 100%;
            padding: 14px 16px;
            background: rgba(15, 12, 41, 0.6);
            border: 1px solid rgba(124, 58, 237, 0.25);
            color: white;
            font-size: 1rem;
            border-radius: 10px;
            margin: 5px 0;
            box-sizing: border-box;
            transition: all 0.3s ease;
        }
        #codeInput:focus {
            outline: none;
            border-color: #a78bfa;
            box-shadow: 0 0 15px rgba(124, 58, 237, 0.2);
        }
        #codeDisplay, #status {
            margin: 10px 0;
            font-size: 1rem;
            color: #a78bfa;
            word-break: break-all;
            transition: color 0.5s;
        }
        .connected #sidebar {
            background: linear-gradient(180deg, rgba(15, 12, 41, 0.92) 0%, rgba(36, 36, 62, 0.88) 100%);
        }
        .connected #chatWindow {
            background: radial-gradient(1200px 600px at 20% 0%, rgba(124, 58, 237, 0.18) 0%, rgba(15, 12, 41, 0.35) 45%, rgba(15, 12, 41, 0.15) 100%);
        }
        .connected #status {
            color: rgba(167, 139, 250, 0.95);
            text-shadow: 0 0 18px rgba(124, 58, 237, 0.35);
        }
        @media (max-width: 480px) {
            #messageControls {
                padding: 10px;
            }
            #messageInput {
                padding: 12px;
            }
            .message {
                max-width: 95%;
                padding: 10px 12px;
            }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideIn { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        /* Header Actions */
        .header-actions {
            display: flex;
            gap: 10px;
        }
        .header-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s;
        }
        .header-btn:hover {
            background: rgba(124, 58, 237, 0.3);
            transform: translateY(-1px);
        }
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.2s ease;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: linear-gradient(145deg, rgba(15, 12, 41, 0.98) 0%, rgba(48, 43, 99, 0.95) 50%, rgba(36, 36, 62, 0.98) 100%);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid rgba(124, 58, 237, 0.3);
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.6), 0 0 30px rgba(124, 58, 237, 0.1);
        }
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid rgba(124, 58, 237, 0.2);
            background: linear-gradient(90deg, rgba(124, 58, 237, 0.1) 0%, rgba(236, 72, 153, 0.05) 100%);
        }
        .modal-header h2 {
            margin: 0;
            background: linear-gradient(135deg, #a78bfa 0%, #ec4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-size: 1.3rem;
        }
        .close-modal {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            padding: 8px;
            line-height: 1;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .close-modal:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
        }
        .modal-body {
            padding: 24px;
        }
        .settings-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(124, 58, 237, 0.15);
        }
        .settings-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .settings-section h3 {
            margin: 0 0 15px 0;
            font-size: 0.85rem;
            color: #a78bfa;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }
        .current-number {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.15) 0%, rgba(168, 85, 247, 0.1) 100%);
            padding: 16px;
            border-radius: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(124, 58, 237, 0.2);
        }
        .number-display {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .number-display span:first-child {
            font-size: 1.2rem;
            color: #a78bfa;
            font-weight: bold;
        }
        .raw-number {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
            font-family: monospace;
        }
        .number-raw {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
            margin-top: 5px;
        }
        .btn.small {
            padding: 8px 15px;
            font-size: 0.85rem;
        }
        .btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }
        .btn.secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .btn.danger {
            background: rgba(255, 80, 80, 0.2);
            color: #f66;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        .btn.danger:hover {
            background: rgba(255, 80, 80, 0.4);
        }
        .number-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        .account-info {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.08) 0%, rgba(168, 85, 247, 0.05) 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(124, 58, 237, 0.15);
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid rgba(124, 58, 237, 0.1);
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-row .label {
            color: rgba(255, 255, 255, 0.6);
        }
        .info-row .value {
            color: #fff;
            font-weight: bold;
        }
        .info-row .value.online {
            color: #0f0;
        }
        /* Status Indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #f66;
        }
        .status-indicator.online .status-dot {
            background: #0f0;
            box-shadow: 0 0 10px #0f0;
        }
        /* Home Button */
        .home-btn {
            width: 100%;
            margin-top: 10px;
            padding: 12px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.2) 0%, rgba(168, 85, 247, 0.15) 100%);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 10px;
            color: #a78bfa;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        .home-btn:hover {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.3) 0%, rgba(168, 85, 247, 0.25) 100%);
            border-color: #a78bfa;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(124, 58, 237, 0.3);
        }
        .home-btn svg {
            flex-shrink: 0;
        }
        /* Chat List Improvements */
        .chat-list-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .chat-list-header h3 {
            margin: 0;
        }
        .new-chat-btn {
            background: rgba(124, 58, 237, 0.15);
            border: 1px dashed rgba(124, 58, 237, 0.4);
            padding: 12px;
            border-radius: 10px;
            color: #a78bfa;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            margin-top: 10px;
        }
        .new-chat-btn:hover {
            background: rgba(124, 58, 237, 0.25);
            border-color: #a78bfa;
        }
        .empty-chats {
            text-align: center;
            padding: 30px 20px;
            color: rgba(255, 255, 255, 0.4);
        }
        .empty-chats svg {
            opacity: 0.3;
            margin-bottom: 10px;
        }
        .empty-chats p {
            margin: 0 0 5px 0;
            font-size: 1rem;
        }
        .empty-chats span {
            font-size: 0.85rem;
        }
        /* My Number Display Clickable */
        .my-number-display {
            cursor: pointer;
            transition: all 0.3s;
        }
        .my-number-display:hover {
            background: rgba(124, 58, 237, 0.2);
            border-color: #a78bfa;
        }
        /* Icon Button */
        .icon-btn {
            background: rgba(255, 255, 255, 0.1);
            padding: 8px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease;
        }
        .icon-btn:hover {
            background: rgba(124, 58, 237, 0.22);
            border-color: rgba(167, 139, 250, 0.25);
            transform: translateY(-1px);
        }
        /* Send Button */
        #sendBtn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.85) 0%, rgba(236, 72, 153, 0.75) 100%);
            border: 1px solid rgba(167, 139, 250, 0.25);
            box-shadow: 0 10px 26px rgba(124, 58, 237, 0.22);
        }
        #sendBtn svg {
            stroke: #fff;
        }
        /* Emoji Picker */
        .emoji-picker-container {
            position: relative;
        }
        #emojiBtn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s;
        }
        #emojiBtn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .emoji-panel {
            display: none;
            position: absolute;
            bottom: 60px;
            left: 0;
            background: linear-gradient(145deg, rgba(15, 12, 41, 0.98) 0%, rgba(48, 43, 99, 0.95) 100%);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 16px;
            padding: 12px;
            width: 280px;
            max-height: 250px;
            overflow-y: auto;
            z-index: 100;
            box-shadow: 0 15px 50px rgba(0, 0, 0, 0.5), 0 0 30px rgba(124, 58, 237, 0.1);
        }
        .emoji-panel.active {
            display: block;
        }
        .emoji-category {
            margin-bottom: 10px;
        }
        .emoji-category-title {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 5px;
            text-transform: uppercase;
        }
        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
        }
        .emoji-item {
            font-size: 1.3rem;
            padding: 5px;
            cursor: pointer;
            border-radius: 5px;
            text-align: center;
            transition: all 0.2s;
        }
        .emoji-item:hover {
            background: rgba(124, 58, 237, 0.3);
            transform: scale(1.2);
        }
        /* Typing Indicator */
        .typing-indicator {
            display: none;
            padding: 10px 15px;
            color: rgba(255, 255, 255, 0.6);
            font-style: italic;
            font-size: 0.9rem;
        }
        .typing-indicator.active {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .typing-dots {
            display: flex;
            gap: 3px;
        }
        .typing-dots span {
            width: 6px;
            height: 6px;
            background: rgba(167, 139, 250, 0.8);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite ease-in-out;
        }
        .typing-dots span:nth-child(1) { animation-delay: 0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
        /* Read Receipts */
        .message-status {
            font-size: 0.7rem;
            margin-left: 5px;
            opacity: 0.7;
        }
        .message-status.sent { color: rgba(255, 255, 255, 0.5); }
        .message-status.delivered { color: #00c2ff; }
        .message-status.read { color: #00ff88; }
        .check-icon {
            width: 14px;
            height: 14px;
        }
        .double-check {
            margin-left: -8px;
        }
        /* Image Messages */
        .message-image {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.3s;
        }
        .message-image:hover {
            transform: scale(1.02);
        }
        #attachBtn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s;
        }
        #attachBtn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        #fileInput {
            display: none;
        }
        /* Image Preview Modal */
        .image-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }
        .image-modal.active {
            display: flex;
        }
        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            object-fit: contain;
        }
        /* Theme Toggle */
        .theme-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
        }
        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .toggle-switch.active {
            background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
        }
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 20px;
            height: 20px;
            background: #fff;
            border-radius: 50%;
            transition: all 0.3s;
        }
        .toggle-switch.active::after {
            left: 27px;
        }
        /* Light Theme */
        body.light-theme {
            background: #f0f2f5;
            color: #1a1a2e;
        }
        body.light-theme #chatPage {
            background: #f0f2f5;
        }
        body.light-theme #dashboardHeader {
            background: #fff;
            border-bottom-color: rgba(0, 0, 0, 0.1);
        }
        body.light-theme #sidebar {
            background: #fff;
            border-right-color: rgba(0, 0, 0, 0.1);
        }
        body.light-theme #chatWindow {
            background: #e5ddd5;
        }
        body.light-theme .message.your-message {
            background: #dcf8c6;
            color: #000;
        }
        body.light-theme .message.friend-message {
            background: #fff;
            color: #000;
        }
        body.light-theme #messageInput {
            background: #fff;
            color: #000;
            border-color: rgba(0, 0, 0, 0.2);
        }
        body.light-theme .modal-content {
            background: #fff;
            color: #000;
        }
        body.light-theme .emoji-panel {
            background: #fff;
        }
        /* Message Search */
        .search-container {
            display: none;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 10px;
        }
        .search-container.active {
            display: flex;
            gap: 10px;
        }
        .search-container input {
            flex: 1;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            color: #fff;
        }
        .search-results {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            padding: 5px 0;
        }
        .message.highlight {
            background: rgba(255, 255, 0, 0.3) !important;
            border: 1px solid rgba(255, 255, 0, 0.5) !important;
        }
        #searchBtn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
        }
        /* Voice Message Button */
        #voiceBtn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
            transition: all 0.3s;
        }
        #voiceBtn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        #voiceBtn.recording {
            background: #ff4444;
            animation: pulse 1s infinite;
        }
        /* Contact List */
        .contacts-section {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        .contact-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .contact-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .contact-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(45deg, #f0f, #0ff);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .contact-info {
            flex: 1;
        }
        .contact-name {
            font-weight: bold;
            font-size: 0.95rem;
        }
        .contact-number {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.5);
        }
        .add-contact-btn {
            background: rgba(0, 255, 255, 0.2);
            border: 1px dashed rgba(0, 255, 255, 0.4);
            padding: 12px;
            border-radius: 8px;
            color: #0ff;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            margin-top: 10px;
        }
        .add-contact-btn:hover {
            background: rgba(0, 255, 255, 0.3);
        }
        /* Chat Item Actions */
        .chat-item {
            position: relative;
        }
        .chat-actions {
            display: none;
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            gap: 5px;
        }
        .chat-item:hover .chat-actions {
            display: flex;
        }
        .chat-action-btn {
            background: rgba(0, 0, 0, 0.5);
            border: none;
            padding: 5px 8px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.7rem;
            transition: all 0.2s;
        }
        .chat-action-btn.save {
            color: #0f0;
        }
        .chat-action-btn.save:hover {
            background: rgba(0, 255, 0, 0.3);
        }
        .chat-action-btn.delete {
            color: #f66;
        }
        .chat-action-btn.delete:hover {
            background: rgba(255, 100, 100, 0.3);
        }
        /* Unread badge */
        .unread-badge {
            background: #0ff;
            color: #000;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: bold;
            min-width: 18px;
            text-align: center;
        }
        /* Chat time */
        .chat-time {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            position: absolute;
            right: 10px;
            top: 10px;
        }
        /* Dial Buttons Container */
        .dial-buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }
        #dialInput {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-sizing: border-box;
        }
        #dialInput:focus {
            outline: none;
            border-color: #00c2ff;
            background: rgba(255, 255, 255, 0.12);
            box-shadow: 0 0 20px rgba(0, 194, 255, 0.15);
        }
        #dialInput::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }
        #dialBtn, #textBtn {
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
            flex: 1;
            padding: 12px 18px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        #dialBtn {
            background: linear-gradient(135deg, #00cc88 0%, #00aa66 100%);
            color: #fff;
            border: none;
            box-shadow: 0 4px 15px rgba(0, 204, 136, 0.3);
        }
        #dialBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 204, 136, 0.4);
        }
        #dialBtn svg {
            stroke: #fff;
        }
        #textBtn {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        #textBtn:hover {
            background: rgba(255, 255, 255, 0.18);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        #textBtn svg {
            stroke: #fff;
        }
        /* ============ MESSAGE REACTIONS ============ */
        .message-reactions {
            display: flex;
            gap: 4px;
            margin-top: 5px;
            flex-wrap: wrap;
        }
        .reaction {
            background: rgba(255, 255, 255, 0.15);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .reaction:hover {
            background: rgba(255, 255, 255, 0.25);
        }
        .reaction .count {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .reaction-picker {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 0;
            background: #15103a;
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
            padding: 5px 10px;
            gap: 5px;
            z-index: 50;
        }
        .reaction-picker.active {
            display: flex;
        }
        .reaction-picker span {
            cursor: pointer;
            font-size: 1.2rem;
            padding: 3px;
            border-radius: 5px;
            transition: all 0.2s;
        }
        .reaction-picker span:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.3);
        }
        .message {
            position: relative;
            -webkit-user-select: none;
            user-select: none;
        }
        .message-actions {
            display: none;
            position: absolute;
            top: -10px;
            right: 10px;
            gap: 5px;
        }
        .message:hover .message-actions {
            display: flex;
        }
        .msg-action-btn {
            background: rgba(0, 0, 0, 0.6);
            border: none;
            padding: 4px 8px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.8rem;
            color: #fff;
            transition: all 0.2s;
        }
        .msg-action-btn:hover {
            background: rgba(0, 255, 255, 0.3);
        }
        /* ============ MESSAGE CONTEXT MENU ============ */
        .message-context-menu {
            position: fixed;
            background: #1a1a2e;
            border: 1px solid rgba(0, 194, 255, 0.3);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 160px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: none;
            animation: contextMenuIn 0.15s ease;
        }
        @keyframes contextMenuIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        .message-context-menu.active {
            display: block;
        }
        .context-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: #fff;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        .context-menu-item:hover {
            background: rgba(0, 194, 255, 0.15);
        }
        .context-menu-item.danger {
            color: #ff6b6b;
        }
        .context-menu-item.danger:hover {
            background: rgba(255, 107, 107, 0.15);
        }
        .context-menu-item svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
        }
        .context-menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 6px 0;
        }
        .message.editing {
            background: rgba(0, 194, 255, 0.2) !important;
            border: 1px solid #00c2ff !important;
        }
        .message.unsent {
            opacity: 0.5;
            font-style: italic;
        }
        /* ============ TOAST NOTIFICATIONS ============ */
        .toast-container {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 5000;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }
        .toast {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border: 1px solid rgba(0, 194, 255, 0.3);
            border-radius: 12px;
            padding: 14px 20px;
            color: #fff;
            font-size: 0.9rem;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            gap: 12px;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
            pointer-events: auto;
            max-width: 320px;
        }
        .toast.success {
            border-color: rgba(0, 255, 136, 0.4);
        }
        .toast.success .toast-icon {
            background: rgba(0, 255, 136, 0.2);
            color: #00ff88;
        }
        .toast.error {
            border-color: rgba(255, 107, 107, 0.4);
        }
        .toast.error .toast-icon {
            background: rgba(255, 107, 107, 0.2);
            color: #ff6b6b;
        }
        .toast.info {
            border-color: rgba(0, 194, 255, 0.4);
        }
        .toast.info .toast-icon {
            background: rgba(0, 194, 255, 0.2);
            color: #00c2ff;
        }
        .toast-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .toast-icon svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
        }
        .toast-message {
            flex: 1;
        }
        @keyframes toastIn {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes toastOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100px); }
        }
        .message .edited-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.4);
            margin-left: 5px;
        }
        /* ============ VOICE MESSAGES ============ */
        .voice-message {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }
        .voice-play-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #00c2ff;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .voice-play-btn svg {
            stroke: #fff;
            fill: #fff;
        }
        .voice-waveform {
            flex: 1;
            height: 30px;
            display: flex;
            align-items: center;
            gap: 2px;
        }
        .voice-waveform .bar {
            width: 3px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 2px;
            transition: height 0.1s;
        }
        .voice-duration {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
            min-width: 35px;
        }
        #voiceBtn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            color: #fff;
        }
        #voiceBtn.recording {
            background: #ff4444;
            animation: pulse 1s infinite;
        }
        .recording-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: rgba(255, 0, 0, 0.2);
            border-radius: 8px;
            color: #ff6666;
        }
        .recording-indicator.active {
            display: flex;
        }
        .recording-dot {
            width: 10px;
            height: 10px;
            background: #ff4444;
            border-radius: 50%;
            animation: pulse 1s infinite;
        }
        /* ============ START A CHAT INTERFACE ============ */
        .start-chat-interface {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 20px;
            animation: fadeIn 0.5s ease;
        }
        .start-chat-card {
            background: linear-gradient(145deg, rgba(15, 12, 41, 0.95) 0%, rgba(48, 43, 99, 0.9) 50%, rgba(36, 36, 62, 0.95) 100%);
            backdrop-filter: blur(30px);
            border-radius: 32px;
            padding: 48px 40px;
            max-width: 480px;
            width: 100%;
            border: 1px solid rgba(124, 58, 237, 0.3);
            box-shadow: 
                0 30px 90px rgba(0, 0, 0, 0.6),
                0 0 120px rgba(124, 58, 237, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.08);
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .start-chat-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: conic-gradient(from 0deg, transparent, rgba(124, 58, 237, 0.08), transparent 30%);
            animation: shimmer 8s linear infinite;
            pointer-events: none;
        }
        .start-chat-card > * {
            position: relative;
            z-index: 1;
        }
        .start-chat-icon {
            font-size: 4rem;
            margin-bottom: 24px;
            display: inline-block;
            animation: float 3s ease-in-out infinite;
            filter: drop-shadow(0 8px 24px rgba(124, 58, 237, 0.4));
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        .start-chat-title {
            margin: 0 0 32px 0;
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #a78bfa 0%, #ec4899 50%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 2px 12px rgba(167, 139, 250, 0.3));
            letter-spacing: -0.5px;
        }
        .start-chat-input {
            width: 100%;
            padding: 18px 24px;
            background: rgba(255, 255, 255, 0.06);
            border: 2px solid rgba(124, 58, 237, 0.25);
            border-radius: 16px;
            color: #fff;
            font-size: 1.1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-sizing: border-box;
            margin-bottom: 24px;
            font-family: 'Exo 2', sans-serif;
            text-align: center;
            letter-spacing: 0.5px;
        }
        .start-chat-input::placeholder {
            color: rgba(255, 255, 255, 0.35);
        }
        .start-chat-input:focus {
            outline: none;
            border-color: #a78bfa;
            background: rgba(124, 58, 237, 0.12);
            box-shadow: 
                0 0 0 4px rgba(124, 58, 237, 0.1),
                0 8px 32px rgba(124, 58, 237, 0.25);
            transform: translateY(-2px);
        }
        .start-chat-buttons {
            display: flex;
            gap: 16px;
            margin-top: 24px;
        }
        .start-chat-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 24px;
            border-radius: 14px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: hidden;
        }
        .start-chat-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        .start-chat-btn:hover::before {
            left: 100%;
        }
        .start-chat-btn.call-btn {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: #fff;
            box-shadow: 0 6px 24px rgba(16, 185, 129, 0.35);
        }
        .start-chat-btn.call-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 32px rgba(16, 185, 129, 0.45);
        }
        .start-chat-btn.call-btn:active {
            transform: translateY(-1px) scale(0.98);
        }
        .start-chat-btn.text-btn {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.85) 0%, rgba(168, 85, 247, 0.75) 100%);
            color: #fff;
            border: 1px solid rgba(167, 139, 250, 0.3);
            box-shadow: 0 6px 24px rgba(124, 58, 237, 0.35);
        }
        .start-chat-btn.text-btn:hover {
            transform: translateY(-3px) scale(1.02);
            box-shadow: 0 10px 32px rgba(124, 58, 237, 0.45);
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.95) 0%, rgba(168, 85, 247, 0.85) 100%);
        }
        .start-chat-btn.text-btn:active {
            transform: translateY(-1px) scale(0.98);
        }
        .start-chat-btn svg {
            stroke: currentColor;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        @media (max-width: 768px) {
            .start-chat-card {
                padding: 36px 28px;
                border-radius: 24px;
            }
            .start-chat-icon {
                font-size: 3rem;
                margin-bottom: 20px;
            }
            .start-chat-title {
                font-size: 1.6rem;
                margin-bottom: 24px;
            }
            .start-chat-input {
                padding: 16px 20px;
                font-size: 1rem;
            }
            .start-chat-buttons {
                flex-direction: column;
                gap: 12px;
            }
            .start-chat-btn {
                padding: 14px 20px;
            }
        }
        /* ============ READ RECEIPTS ============ */
        .message-status {
            display: inline-flex;
            align-items: center;
            margin-left: 5px;
            font-size: 0.75rem;
        }
        .message-status.sent { color: rgba(255, 255, 255, 0.4); }
        .message-status.delivered { color: #00c2ff; }
        .message-status.read { color: #00ff88; }
        .check-icon {
            width: 14px;
            height: 14px;
        }
        .double-check {
            margin-left: -8px;
        }
        /* ============ PROFILE PICTURES ============ */
        .profile-pic {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            background: linear-gradient(45deg, #0ff, #f0f);
        }
        .profile-pic-large {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            cursor: pointer;
            border: 3px solid rgba(0, 255, 255, 0.3);
        }
        .profile-upload {
            position: relative;
            display: inline-block;
        }
        .profile-upload input {
            display: none;
        }
        .profile-upload-overlay {
            position: absolute;
            bottom: 0;
            right: 0;
            background: #00c2ff;
            border-radius: 50%;
            padding: 5px;
            cursor: pointer;
        }
        /* ============ BLOCK/MUTE ============ */
        .blocked-indicator {
            background: rgba(255, 0, 0, 0.2);
            color: #ff6666;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85rem;
            text-align: center;
        }
        .muted-icon {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem;
        }
        /* ============ LINK PREVIEWS ============ */
        .link-preview {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid #00c2ff;
            border-radius: 0 8px 8px 0;
            padding: 10px;
            margin-top: 8px;
            max-width: 300px;
        }
        .link-preview-title {
            font-weight: bold;
            font-size: 0.9rem;
            margin-bottom: 5px;
            color: #00c2ff;
        }
        .link-preview-description {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .link-preview-url {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 5px;
        }
        /* ============ REPLY TO MESSAGE ============ */
        .reply-preview {
            background: rgba(0, 255, 255, 0.1);
            border-left: 3px solid #00c2ff;
            padding: 8px 12px;
            margin-bottom: 10px;
            border-radius: 0 8px 8px 0;
            display: none;
            align-items: center;
            justify-content: space-between;
        }
        .reply-preview.active {
            display: flex;
        }
        .reply-preview-content {
            flex: 1;
            overflow: hidden;
        }
        .reply-preview-name {
            font-size: 0.8rem;
            color: #00c2ff;
            font-weight: bold;
        }
        .reply-preview-text {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.7);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .reply-close {
            background: none;
            border: none;
            color: #fff;
            cursor: pointer;
            padding: 5px;
            font-size: 1.2rem;
        }
        .message-reply-quote {
            background: rgba(0, 0, 0, 0.2);
            border-left: 2px solid #00c2ff;
            padding: 5px 10px;
            margin-bottom: 5px;
            border-radius: 0 5px 5px 0;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.7);
        }
        .message-reply-quote .reply-name {
            color: #00c2ff;
            font-weight: bold;
            font-size: 0.75rem;
        }
        /* ============ GROUP CHATS ============ */
        .group-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        .group-members {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.6);
        }
        .create-group-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
            margin-top: 10px;
        }
        .member-list {
            max-height: 200px;
            overflow-y: auto;
        }
        .member-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
        }
        .member-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        .member-item.selected {
            background: rgba(0, 255, 255, 0.2);
        }
        .member-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid rgba(255, 255, 255, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .member-item.selected .member-checkbox {
            background: #00c2ff;
            border-color: #00c2ff;
        }
        /* ============ LAST SEEN STATUS ============ */
        .last-seen {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.5);
        }
        .online-dot {
            width: 8px;
            height: 8px;
            background: #00ff00;
            border-radius: 50%;
            margin-right: 5px;
            box-shadow: 0 0 5px #00ff00;
        }
        /* ============ CHAT EMPTY STATE ============ */
        .chat-empty-state {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: radial-gradient(ellipse 80% 50% at 50% 40%, rgba(124, 58, 237, 0.12), transparent),
                        radial-gradient(ellipse 60% 40% at 80% 60%, rgba(236, 72, 153, 0.08), transparent),
                        linear-gradient(135deg, rgba(15, 12, 41, 0.95) 0%, rgba(36, 36, 62, 0.9) 100%);
            z-index: 100;
            text-align: center;
            padding: 40px;
            animation: fadeIn 0.6s ease;
        }
        .chat-empty-state.hidden {
            display: none;
        }
        #chatWindow:has(.chat-empty-state:not(.hidden)) .chat-header {
            display: none !important;
        }
        #chatWindow:has(.chat-empty-state:not(.hidden)) #messages {
            display: none !important;
        }
        #chatWindow:has(.chat-empty-state:not(.hidden)) #messageControls {
            display: none !important;
        }
        .empty-state-icon {
            width: 160px;
            height: 160px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 36px;
            animation: float 4s ease-in-out infinite, glow-pulse 3s ease-in-out infinite;
            box-shadow: 0 0 80px rgba(102, 126, 234, 0.5), 0 0 120px rgba(118, 75, 162, 0.3);
            position: relative;
        }
        .empty-state-icon::before {
            content: '';
            position: absolute;
            inset: -3px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2, #f093fb);
            z-index: -1;
            opacity: 0.6;
            filter: blur(20px);
            animation: rotate-glow 8s linear infinite;
        }
        @keyframes rotate-glow {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @keyframes float {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-20px) scale(1.03); }
        }
        @keyframes glow-pulse {
            0%, 100% { 
                box-shadow: 0 0 80px rgba(102, 126, 234, 0.5), 0 0 120px rgba(118, 75, 162, 0.3);
            }
            50% { 
                box-shadow: 0 0 100px rgba(102, 126, 234, 0.7), 0 0 150px rgba(118, 75, 162, 0.5);
            }
        }
        .empty-state-icon svg {
            width: 80px;
            height: 80px;
            stroke: white;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.4));
        }
        .empty-state-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: white;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #a78bfa 0%, #ec4899 50%, #06b6d4 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(0 2px 12px rgba(167, 139, 250, 0.3));
            letter-spacing: -0.5px;
        }
        .empty-state-subtitle {
            font-size: 1.05rem;
            color: rgba(255, 255, 255, 0.65);
            margin-bottom: 48px;
            max-width: 420px;
            line-height: 1.7;
            font-weight: 400;
        }
        .empty-state-features {
            display: flex;
            gap: 20px;
            margin-bottom: 48px;
            flex-wrap: wrap;
            justify-content: center;
        }
        .empty-feature {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
            padding: 24px 28px;
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            min-width: 110px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        .empty-feature::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: left 0.6s ease;
        }
        .empty-feature:hover::before {
            left: 100%;
        }
        .empty-feature:hover {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
            transform: translateY(-8px) scale(1.05);
            border-color: rgba(167, 139, 250, 0.4);
            box-shadow: 0 12px 32px rgba(124, 58, 237, 0.25);
        }
        .empty-feature-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.2);
        }
        .empty-feature:hover .empty-feature-icon {
            transform: scale(1.1) rotate(5deg);
        }
        .empty-feature-icon.chat-icon {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .empty-feature-icon.call-icon {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }
        .empty-feature-icon.video-icon {
            background: linear-gradient(135deg, #ec4899 0%, #be185d 100%);
        }
        .empty-feature-icon svg {
            width: 26px;
            height: 26px;
            stroke: white;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }
        .empty-feature-text {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.85);
            font-weight: 600;
            letter-spacing: 0.3px;
        }
        .empty-state-hint {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 32px;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.18) 0%, rgba(236, 72, 153, 0.12) 50%, rgba(6, 182, 212, 0.10) 100%);
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 50px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.95rem;
            font-weight: 500;
            animation: hint-pulse 3s ease-in-out infinite;
            box-shadow: 0 4px 20px rgba(124, 58, 237, 0.15);
        }
        @keyframes hint-pulse {
            0%, 100% { 
                border-color: rgba(124, 58, 237, 0.3);
                box-shadow: 0 4px 20px rgba(124, 58, 237, 0.15);
            }
            50% { 
                border-color: rgba(167, 139, 250, 0.6);
                box-shadow: 0 6px 28px rgba(124, 58, 237, 0.25);
            }
        }
        .empty-state-hint svg {
            width: 20px;
            height: 20px;
            stroke: #a78bfa;
            filter: drop-shadow(0 2px 4px rgba(167, 139, 250, 0.3));
        }
        @media (max-width: 768px) {
            .empty-state-icon {
                width: 130px;
                height: 130px;
                margin-bottom: 28px;
            }
            .empty-state-icon svg {
                width: 65px;
                height: 65px;
            }
            .empty-state-title {
                font-size: 1.8rem;
                margin-bottom: 12px;
            }
            .empty-state-subtitle {
                font-size: 0.95rem;
                margin-bottom: 36px;
                max-width: 320px;
            }
            .empty-state-features {
                gap: 16px;
                margin-bottom: 36px;
            }
            .empty-feature {
                padding: 20px 24px;
                min-width: 95px;
            }
            .empty-feature-icon {
                width: 48px;
                height: 48px;
            }
            .empty-state-hint {
                padding: 14px 24px;
                font-size: 0.85rem;
            }
        }
        /* ============ CALL FEATURE ============ */
        .call-btn {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.85) 0%, rgba(236, 72, 153, 0.75) 100%) !important;
            color: #fff !important;
            border: 1px solid rgba(167, 139, 250, 0.28) !important;
            box-shadow: 0 12px 28px rgba(124, 58, 237, 0.22) !important;
        }
        .call-btn:hover {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.95) 0%, rgba(236, 72, 153, 0.85) 100%) !important;
        }
        .call-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(1200px 800px at 50% 0%, rgba(124, 58, 237, 0.25) 0%, rgba(0, 0, 0, 0.85) 55%, rgba(0, 0, 0, 0.92) 100%);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .call-modal.active {
            display: flex;
        }
        .call-modal-content {
            text-align: center;
            color: white;
            padding: 34px;
            width: min(680px, calc(100% - 40px));
            border-radius: 22px;
            background: linear-gradient(145deg, rgba(15, 12, 41, 0.92) 0%, rgba(48, 43, 99, 0.88) 55%, rgba(36, 36, 62, 0.92) 100%);
            border: 1px solid rgba(124, 58, 237, 0.28);
            box-shadow: 0 25px 90px rgba(0, 0, 0, 0.65), 0 0 40px rgba(124, 58, 237, 0.14);
            backdrop-filter: blur(18px);
        }
        .call-status {
            font-size: 1rem;
            color: rgba(167, 139, 250, 0.9);
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .call-avatar {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.95) 0%, rgba(236, 72, 153, 0.85) 60%, rgba(6, 182, 212, 0.7) 100%);
            border: 3px solid rgba(167, 139, 250, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            margin: 0 auto 20px;
            box-shadow: 0 0 40px rgba(124, 58, 237, 0.25);
        }
        .call-name {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .call-timer {
            font-size: 2rem;
            font-family: monospace;
            color: rgba(167, 139, 250, 0.95);
            margin-bottom: 30px;
        }
        .call-video-container {
            display: none;
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto 30px;
            min-height: 300px;
            background: #000;
            border-radius: 12px;
            overflow: hidden;
        }
        .call-video-container.active {
            display: block;
        }
        #remoteVideo {
            width: 100%;
            height: 100%;
            min-height: 300px;
            border-radius: 10px;
            background: #000;
            object-fit: cover;
        }
        #localVideo {
            position: absolute;
            bottom: 15px;
            right: 15px;
            width: 150px;
            height: 120px;
            border-radius: 10px;
            border: 3px solid rgba(167, 139, 250, 0.45);
            background: #222;
            object-fit: cover;
            z-index: 10;
            -webkit-transform: scaleX(-1);
            transform: scaleX(-1);
        }
        /* Mobile video adjustments */
        @media (max-width: 768px) {
            .call-video-container {
                min-height: 250px;
                max-width: 100%;
                border-radius: 0;
            }
            #remoteVideo {
                min-height: 250px;
            }
            #localVideo {
                width: 100px;
                height: 80px;
                bottom: 10px;
                right: 10px;
            }
            .call-modal-content {
                padding: 20px;
            }
            .call-controls {
                gap: 15px;
            }
            .call-control-btn {
                width: 50px;
                height: 50px;
            }
        }
        .call-controls {
            display: flex;
            justify-content: center;
            gap: 20px;
        }
        .call-control-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 1px solid rgba(255, 255, 255, 0.10);
            background: rgba(255, 255, 255, 0.08);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease;
            backdrop-filter: blur(10px);
        }
        .call-control-btn:hover {
            background: rgba(124, 58, 237, 0.18);
            border-color: rgba(167, 139, 250, 0.25);
            transform: translateY(-1px);
        }
        .call-control-btn.active {
            background: rgba(239, 68, 68, 0.9);
            border-color: rgba(248, 113, 113, 0.6);
        }
        .call-control-btn.end-call {
            background: rgba(239, 68, 68, 0.92);
            border-color: rgba(248, 113, 113, 0.6);
        }
        .call-control-btn.end-call:hover {
            background: rgba(248, 113, 113, 0.95);
        }
        .incoming-call-controls {
            display: flex;
            justify-content: center;
            gap: 40px;
        }
        .call-control-btn.decline {
            background: rgba(239, 68, 68, 0.92);
        }
        .call-control-btn.accept {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.95) 0%, rgba(16, 185, 129, 0.9) 100%);
        }
        .call-control-btn.accept:hover {
            background: linear-gradient(135deg, rgba(34, 197, 94, 1) 0%, rgba(16, 185, 129, 0.95) 100%);
        }
        .call-type {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 30px;
        }
        .call-modal.incoming .call-avatar {
            animation: ring 1s infinite;
        }
        @keyframes ring {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(-10deg); }
            75% { transform: rotate(10deg); }
        }
    </style>
</head>
<body>
    <div id="intro">
        <img class="intro-logo" src="24E694E8-F40A-46B0-8809-DED26FF7E3CE (1).png" alt="Quick Wrap logo">
        <h1>Quick Wrap: Simple TEXT Chat</h1>
        <div class="privacy-badge">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
            </svg>
            <span>End-to-end encrypted &bull; No chats saved</span>
        </div>

        <div class="intro-main">
            <div class="intro-left">
                <!-- Download Section -->
                <div class="intro-panel download-section">
                    <h3>
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Get the Desktop App
                    </h3>
                    <a href="https://github.com/onetwo346/Quick-Wrap/releases/download/v1.2.0/Quick-Wrap-Setup.exe" class="download-btn">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M0 3.449L9.75 2.1v9.451H0m10.949-9.602L24 0v11.4H10.949M0 12.6h9.75v9.451L0 20.699M10.949 12.6H24V24l-12.9-1.801"/>
                        </svg>
                        <span class="btn-text">
                            <span class="btn-label">Download for</span>
                            <span class="btn-platform">Windows</span>
                        </span>
                    </a>
                    <div class="download-info">
                        <span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                            v1.2.0
                        </span>
                        <span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                            Windows 10/11
                        </span>
                        <span>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            168 MB
                        </span>
                    </div>
                </div>
            </div>

            <div class="intro-right">
                <div id="authForms" class="intro-panel">
                    <div id="loginForm" class="auth-form">
                        <h2>Login</h2>
                        <input type="text" id="loginUsername" placeholder="Username" required>
                        <input type="password" id="loginPassword" placeholder="Password" required>
                        <button id="loginBtn">Login</button>
                        <p>Don't have an account? <a href="#" id="showSignup">Sign up</a></p>
                    </div>
                    <div id="signupForm" class="auth-form" style="display: none;">
                        <h2>Sign Up</h2>
                        <input type="text" id="signupUsername" placeholder="Username" required>
                        <input type="password" id="signupPassword" placeholder="Password" required>
                        <div class="phone-selection">
                            <label>Choose your virtual number:</label>
                            <select id="countrySelect">
                                <option value="">Select Country</option>
                            </select>
                            <select id="areaCodeSelect" disabled>
                                <option value="">Select Area Code</option>
                            </select>
                        </div>
                        <button id="signupBtn">Sign Up & Get Number</button>
                        <p>Already have an account? <a href="#" id="showLogin">Login</a></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="chatPage">
        <div id="sidebarOverlay"></div>
        <button id="sidebarToggle">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="3" y1="12" x2="21" y2="12"></line>
                <line x1="3" y1="6" x2="21" y2="6"></line>
                <line x1="3" y1="18" x2="21" y2="18"></line>
            </svg>
        </button>

        <div id="dashboardHeader">
            <div id="userInfo">
                <div id="userAvatar"></div>
                <span id="userName"></span>
            </div>
            <div class="header-actions">
                <button id="settingsBtn" class="header-btn" title="Settings">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
                <button id="signOutBtn" class="header-btn" title="Sign Out">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                        <polyline points="16 17 21 12 16 7"></polyline>
                        <line x1="21" y1="12" x2="9" y2="12"></line>
                    </svg>
                </button>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settingsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2>Settings</h2>
                    <button class="close-modal" onclick="closeSettings()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="settings-section">
                        <h3>Your Phone Number</h3>
                        <div class="current-number">
                            <div class="number-display">
                                <span id="settingsPhoneDisplay">+1 (718) 326-3316</span>
                                <span id="settingsPhoneRaw" class="raw-number">17183263316</span>
                            </div>
                            <button id="copyNumberBtn" class="btn small">Copy</button>
                        </div>
                        <button id="changeNumberBtn" class="btn secondary">Change Number</button>
                    </div>
                    
                    <div id="changeNumberSection" class="settings-section" style="display: none;">
                        <h3>Select New Number</h3>
                        <div class="phone-selection">
                            <select id="settingsCountrySelect">
                                <option value="">Select Country</option>
                            </select>
                            <select id="settingsAreaCodeSelect" disabled>
                                <option value="">Select Area Code</option>
                            </select>
                        </div>
                        <div class="number-actions">
                            <button id="generateNewNumberBtn" class="btn primary">Generate New Number</button>
                            <button id="cancelChangeBtn" class="btn secondary">Cancel</button>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Account</h3>
                        <div class="account-info">
                            <div class="info-row">
                                <span class="label">Username</span>
                                <span id="settingsUsername" class="value">username</span>
                            </div>
                            <div class="info-row">
                                <span class="label">Status</span>
                                <span id="settingsStatus" class="value online">Online</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Appearance</h3>
                        <div class="theme-toggle">
                            <span>Light Theme</span>
                            <div id="themeToggle" class="toggle-switch" onclick="toggleTheme()"></div>
                        </div>
                        <div class="theme-toggle">
                            <span>Notification Sounds</span>
                            <div id="soundToggle" class="toggle-switch active" onclick="toggleSound()"></div>
                        </div>
                    </div>
                    
                    <div class="settings-section">
                        <h3>Danger Zone</h3>
                        <button id="clearChatsBtn" class="btn danger">Clear All Chats</button>
                        <button id="deleteAccountBtn" class="btn danger">Delete Account</button>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="chat-container">
            <div id="sidebar">
                <div class="my-number-display" onclick="openSettings()">
                    <label>Your Number (tap to manage)</label>
                    <div class="number" id="myPhoneNumber">Loading...</div>
                    <div class="number-raw" id="myPhoneRaw"></div>
                </div>
                <div class="connection-setup" style="display: none;">
                    <h3>Start a Chat</h3>
                    <div class="setup-options">
                        <div class="option-card">
                            <input type="tel" id="dialInput" placeholder="Enter phone number to dial...">
                            <div class="dial-buttons">
                                <button id="dialBtn" class="btn primary">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                    </svg>
                                    Call
                                </button>
                                <button id="textBtn" class="btn secondary">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                    </svg>
                                    Text
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="status-box">
                    <div id="onlineStatus" class="status-indicator">
                        <span class="status-dot"></span>
                        <span>Offline</span>
                    </div>
                    <div id="status">Connecting...</div>
                </div>
                
                <button id="homeBtn" class="home-btn" onclick="showHomeView()" title="Home">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <polyline points="9 22 9 12 15 12 15 22"></polyline>
                    </svg>
                    Home
                </button>
                
                <div class="chat-list">
                    <div class="chat-list-header">
                        <h3>Chats</h3>
                        <button class="new-chat-btn" onclick="showDialer()">+ New</button>
                    </div>
                    <div id="chatsList">
                        <div class="empty-chats">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                            <p>No chats yet</p>
                            <span>Dial a number to start chatting</span>
                        </div>
                    </div>
                </div>
            </div>
            <div id="chatWindow">
                <div class="chat-header">
                    <div class="peer-avatar"></div>
                    <div class="peer-info">
                        <div class="peer-name">Not Connected</div>
                        <div class="peer-status">Dial a number to start a chat</div>
                    </div>
                    <div class="actions">
                        <button id="voiceCallBtn" class="btn icon-btn call-btn" onclick="startVoiceCall()" title="Voice Call">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                            </svg>
                        </button>
                        <button id="videoCallBtn" class="btn icon-btn call-btn" onclick="startVideoCall()" title="Video Call">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                            </svg>
                        </button>
                        <button id="searchBtn" class="btn icon-btn" title="Search Messages">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                        </button>
                        <button class="btn icon-btn" onclick="cleanup()" title="End Chat">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
                <div class="search-container" id="searchContainer">
                    <input type="text" id="searchInput" placeholder="Search messages...">
                    <button onclick="searchMessages()" class="btn small">Search</button>
                    <button onclick="closeSearch()" class="btn small secondary">Close</button>
                </div>
                
                <!-- Chat Empty State -->
                <div class="chat-empty-state" id="chatEmptyState">
                    <div class="empty-state-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            <path d="M8 9h8M8 13h6" stroke-linecap="round"></path>
                        </svg>
                    </div>
                    <div class="empty-state-title">Welcome to Quick Wrap, <span id="emptyStateUsername">User</span>!</div>
                    <div class="empty-state-subtitle">Connect with anyone, anywhere. Start a conversation by selecting a chat or entering a number.</div>
                    <div class="empty-state-features">
                        <div class="empty-feature">
                            <div class="empty-feature-icon chat-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                            </div>
                            <span class="empty-feature-text">Text</span>
                        </div>
                        <div class="empty-feature">
                            <div class="empty-feature-icon call-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                </svg>
                            </div>
                            <span class="empty-feature-text">Voice</span>
                        </div>
                        <div class="empty-feature">
                            <div class="empty-feature-icon video-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="23 7 16 12 23 17 23 7"></polygon>
                                    <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                                </svg>
                            </div>
                            <span class="empty-feature-text">Video</span>
                        </div>
                    </div>
                    <div class="empty-state-hint">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M5 12h14M12 5l7 7-7 7"></path>
                        </svg>
                        <span>Select a chat or dial a number to begin</span>
                    </div>
                </div>
                
                <!-- Start a Chat Interface (appears in main chat window) -->
                <div class="start-chat-interface" id="startChatInterface" style="display: none;">
                    <div class="start-chat-card">
                        <div class="start-chat-icon"></div>
                        <h2 class="start-chat-title">Start a Chat</h2>
                        <input type="tel" id="mainDialInput" class="start-chat-input" placeholder="Enter phone number to dial...">
                        <div class="start-chat-buttons">
                            <button id="mainCallBtn" class="start-chat-btn call-btn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                </svg>
                                Call
                            </button>
                            <button id="mainTextBtn" class="start-chat-btn text-btn">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                                </svg>
                                Text
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="messages"></div>
                <div class="typing-indicator" id="typingIndicator">
                    <div class="typing-dots">
                        <span></span><span></span><span></span>
                    </div>
                    <span>typing...</span>
                </div>
                <!-- Reply Preview -->
                <div class="reply-preview" id="replyPreview">
                    <div class="reply-preview-content">
                        <div class="reply-preview-name" id="replyName">Replying to</div>
                        <div class="reply-preview-text" id="replyText">Message text...</div>
                    </div>
                    <button class="reply-close" onclick="cancelReply()"></button>
                </div>
                <!-- Recording Indicator -->
                <div class="recording-indicator" id="recordingIndicator">
                    <div class="recording-dot"></div>
                    <span id="recordingTime">0:00</span>
                    <span>Recording...</span>
                    <button onclick="cancelRecording()" class="btn small danger">Cancel</button>
                </div>
                <div id="messageControls">
                    <div class="emoji-picker-container">
                        <button id="emojiBtn" title="Emoji"></button>
                        <div class="emoji-panel" id="emojiPanel">
                            <div class="emoji-category">
                                <div class="emoji-category-title">Smileys</div>
                                <div class="emoji-grid" id="emojiGrid"></div>
                            </div>
                        </div>
                    </div>
                    <button id="attachBtn" title="Attach File">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
                        </svg>
                    </button>
                    <input type="file" id="fileInput" accept="image/*">
                    <input id="messageInput" placeholder="Type a message...">
                    <button id="voiceBtn" title="Voice Message">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                            <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                            <line x1="12" y1="19" x2="12" y2="23"></line>
                            <line x1="8" y1="23" x2="16" y2="23"></line>
                        </svg>
                    </button>
                    <button id="sendBtn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="22" y1="2" x2="11" y2="13"></line>
                            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Image Preview Modal -->
    <div class="image-modal" id="imageModal" onclick="closeImageModal()">
        <img id="modalImage" src="" alt="Preview">
    </div>
    
    <!-- Add Contact Modal -->
    <div id="addContactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add Contact</h2>
                <button class="close-modal" onclick="closeAddContactModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="auth-form">
                    <input type="text" id="contactName" placeholder="Contact Name">
                    <input type="tel" id="contactNumber" placeholder="Phone Number">
                    <button onclick="saveContact()" class="btn primary">Save Contact</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Call Modal -->
    <div id="callModal" class="call-modal">
        <div class="call-modal-content">
            <div class="call-status" id="callStatus">Calling...</div>
            <div class="call-avatar" id="callAvatar">?</div>
            <div class="call-name" id="callName">Unknown</div>
            <div class="call-timer" id="callTimer">00:00</div>
            <div class="call-video-container" id="callVideoContainer">
                <video id="remoteVideo" autoplay playsinline></video>
                <video id="localVideo" autoplay playsinline muted></video>
            </div>
            <div class="call-controls">
                <button class="call-control-btn" id="toggleMuteBtn" onclick="toggleMute()" title="Mute">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"></path>
                        <line x1="12" y1="19" x2="12" y2="23"></line>
                        <line x1="8" y1="23" x2="16" y2="23"></line>
                    </svg>
                </button>
                <button class="call-control-btn" id="toggleVideoBtn" onclick="toggleVideo()" title="Camera" style="display: none;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="23 7 16 12 23 17 23 7"></polygon>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect>
                    </svg>
                </button>
                <button class="call-control-btn" id="toggleSpeakerBtn" onclick="toggleSpeaker()" title="Speaker">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon>
                        <path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path>
                    </svg>
                </button>
                <button class="call-control-btn end-call" onclick="endCall()" title="End Call">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Incoming Call Modal -->
    <div id="incomingCallModal" class="call-modal incoming">
        <div class="call-modal-content">
            <div class="call-status">Incoming Call</div>
            <div class="call-avatar" id="incomingCallAvatar">?</div>
            <div class="call-name" id="incomingCallName">Unknown</div>
            <div class="call-type" id="incomingCallType">Voice Call</div>
            <div class="incoming-call-controls">
                <button class="call-control-btn decline" onclick="declineCall()" title="Decline">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.42 19.42 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"></path>
                        <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                </button>
                <button class="call-control-btn accept" onclick="acceptCall()" title="Accept">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                    </svg>

                </button>
            </div>
        </div>
    </div>
    
    <!-- Toast Container -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- Message Context Menu -->
    <div id="messageContextMenu" class="message-context-menu">
        <div class="context-menu-item" onclick="copyMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span>Copy</span>
        </div>
        <div class="context-menu-item" id="editMenuItem" onclick="editMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
            <span>Edit</span>
        </div>
        <div class="context-menu-item" onclick="replyFromContext()">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <polyline points="9 14 4 9 9 4"></polyline>
                <path d="M20 20v-7a4 4 0 0 0-4-4H4"></path>
            </svg>
            <span>Reply</span>
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item danger" id="unsendMenuItem" onclick="unsendMessage()">
            <svg viewBox="0 0 24 24" fill="none" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            <span>Unsend</span>
        </div>
    </div>

    <script>
        // Initialize admin account
        Auth.initAdmin();

        let peer = null;
        let conn = null;
        let currentCode = null;
        let isInitiator = false;
        let activeChats = {};
        let currentChatId = null;
        let contextMenuTarget = null;
        let contextMenuMsgId = null;
        
        // ============ TOAST NOTIFICATIONS ============
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let iconSvg = '';
            if (type === 'success') {
                iconSvg = '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><polyline points="20 6 9 17 4 12"></polyline></svg>';
            } else if (type === 'error') {
                iconSvg = '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';
            } else {
                iconSvg = '<svg viewBox="0 0 24 24" fill="none" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
            }
            
            toast.innerHTML = `
                <div class="toast-icon">${iconSvg}</div>
                <div class="toast-message">${message}</div>
            `;
            
            container.appendChild(toast);
            
            // Remove after animation
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }
        
        // ============ CHAT PERSISTENCE ============
        function getChatStorageKey() {
            const username = Auth.getCurrentUser();
            return `quickwrap_chats_${username}`;
        }
        
        function loadSavedChats() {
            const key = getChatStorageKey();
            const saved = localStorage.getItem(key);
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    // Restore chats without connection objects
                    for (const chatId in parsed) {
                        activeChats[chatId] = {
                            ...parsed[chatId],
                            connection: null // Will be re-established when they connect
                        };
                    }
                    updateChatsList();
                } catch (e) {
                    console.error('Failed to load saved chats:', e);
                }
            }
        }
        
        function saveChatsToStorage() {
            const key = getChatStorageKey();
            // Save chats without connection objects (can't serialize)
            const toSave = {};
            for (const chatId in activeChats) {
                toSave[chatId] = {
                    id: activeChats[chatId].id,
                    name: activeChats[chatId].name,
                    phoneNumber: activeChats[chatId].phoneNumber,
                    initial: activeChats[chatId].initial,
                    messages: activeChats[chatId].messages,
                    lastMessageTime: activeChats[chatId].lastMessageTime || new Date().toISOString(),
                    unreadCount: activeChats[chatId].unreadCount || 0,
                    isSavedContact: activeChats[chatId].isSavedContact || false
                };
            }
            localStorage.setItem(key, JSON.stringify(toSave));
        }
        
        function deleteChat(chatId) {
            if (confirm('Delete this chat? Messages will be lost.')) {
                // Close connection if active
                if (activeChats[chatId] && activeChats[chatId].connection) {
                    activeChats[chatId].connection.close();
                }
                delete activeChats[chatId];
                saveChatsToStorage();
                updateChatsList();
                
                // Clear current chat if it was the deleted one
                if (currentChatId === chatId) {
                    showHomeView();
                }
            }
        }
        
        function saveContactFromChat(chatId) {
            const chat = activeChats[chatId];
            if (!chat) return;
            
            const name = prompt('Enter a name for this contact:', chat.name);
            if (name && name.trim()) {
                // Add to contacts
                const rawNumber = PhoneData.peerIdToDigits(chatId);
                contacts.push({ 
                    name: name.trim(), 
                    number: rawNumber, 
                    displayNumber: chat.phoneNumber 
                });
                saveContactsToStorage();
                
                // Update chat name
                activeChats[chatId].name = name.trim();
                activeChats[chatId].initial = name.trim().charAt(0).toUpperCase();
                activeChats[chatId].isSavedContact = true;
                saveChatsToStorage();
                updateChatsList();
                
                // Update header if this is current chat
                if (currentChatId === chatId) {
                    document.querySelector('.peer-name').textContent = name.trim();
                    document.querySelector('.peer-avatar').textContent = name.trim().charAt(0).toUpperCase();
                }
                
                addMessage(`Contact "${name.trim()}" saved!`, 'system-message');
            }
        }

        const elements = {
            intro: document.getElementById('intro'),
            chatPage: document.getElementById('chatPage'),
            dialBtn: document.getElementById('dialBtn'),
            dialInput: document.getElementById('dialInput'),
            myPhoneNumber: document.getElementById('myPhoneNumber'),
            messages: document.getElementById('messages'),
            messageInput: document.getElementById('messageInput'),
            sendBtn: document.getElementById('sendBtn'),
            status: document.getElementById('status')
        };

        const authElements = {
            loginForm: document.getElementById('loginForm'),
            signupForm: document.getElementById('signupForm'),
            loginUsername: document.getElementById('loginUsername'),
            loginPassword: document.getElementById('loginPassword'),
            signupUsername: document.getElementById('signupUsername'),
            signupPassword: document.getElementById('signupPassword'),
            loginBtn: document.getElementById('loginBtn'),
            signupBtn: document.getElementById('signupBtn'),
            showLogin: document.getElementById('showLogin'),
            showSignup: document.getElementById('showSignup'),
            userAvatar: document.getElementById('userAvatar'),
            userName: document.getElementById('userName'),
            signOutBtn: document.getElementById('signOutBtn')
        };

        function setupDashboard(username) {
            document.getElementById('intro').style.display = 'none';
            document.getElementById('chatPage').style.display = 'block';
            document.getElementById('userAvatar').textContent = username[0].toUpperCase();
            document.getElementById('userName').textContent = username;
            
            // Update empty state with username
            const emptyStateUsername = document.getElementById('emptyStateUsername');
            if (emptyStateUsername) {
                emptyStateUsername.textContent = username;
            }
            
            // Display user's phone number and raw number for dialing
            const userData = Auth.getCurrentUserData();
            if (userData) {
                // Check if user has phoneRaw (new system) or just phoneNumber (old system)
                if (userData.phoneRaw) {
                    elements.myPhoneNumber.textContent = userData.phoneNumber;
                    document.getElementById('myPhoneRaw').textContent = `Dial: ${userData.phoneRaw}`;
                    const peerId = PhoneData.digitsToPeerId(userData.phoneRaw);
                    setupPeer(peerId, true);
                } else if (userData.phoneNumber) {
                    // Old system - convert phoneNumber to raw format
                    const rawDigits = PhoneData.normalizeToDigits(userData.phoneNumber);
                    elements.myPhoneNumber.textContent = userData.phoneNumber;
                    document.getElementById('myPhoneRaw').textContent = `Dial: ${rawDigits}`;
                    const peerId = PhoneData.digitsToPeerId(rawDigits);
                    setupPeer(peerId, true);
                } else {
                    elements.myPhoneNumber.textContent = 'No number assigned';
                    document.getElementById('myPhoneRaw').textContent = 'Go to Settings to get a number';
                }
            } else {
                elements.myPhoneNumber.textContent = 'No number assigned';
                document.getElementById('myPhoneRaw').textContent = '';
            }
            
            // Make sure chat interface elements are visible
            document.querySelector('.chat-header').style.display = 'flex';
            document.getElementById('messages').style.display = 'block';
            document.getElementById('messageControls').style.display = 'flex';
            
            // Add initial welcome message
            document.getElementById('messages').innerHTML = '';
            addMessage('Welcome to Quick Wrap! Enter a phone number to start chatting.', 'system-message');
            
            // Update peer name in header
            document.querySelector('.peer-name').textContent = 'Not Connected';
            document.querySelector('.peer-status').textContent = 'Dial a number to start a chat';
            
            // Load saved chats from storage
            loadSavedChats();
        }

        function setupPeer(id, initiator) {
            try {
                if (peer) {
                    peer.destroy();
                    peer = null;
                }
                
                isInitiator = initiator;
                currentCode = id;
                elements.status.textContent = 'Status: Connecting...';
                console.log('Setting up peer with ID:', id);
                
                // Use the exact phone-based ID so others can find us
                // This is the key to real P2P - consistent, predictable peer IDs
                peer = new Peer(id, {
                    debug: 2,
                    config: {
                        iceServers: [
                            { urls: 'stun:stun.l.google.com:19302' },
                            { urls: 'stun:stun1.l.google.com:19302' },
                            { urls: 'stun:stun2.l.google.com:19302' },
                            { urls: 'stun:stun3.l.google.com:19302' }
                        ]
                    }
                });
                
                console.log('Peer object created, waiting for open event...');
                
                peer.on('open', (id) => {
                    console.log('My peer ID is: ' + id);
                    elements.status.textContent = 'Status: Online - Ready';
                    const statusIndicator = document.getElementById('onlineStatus');
                    if (statusIndicator) {
                        statusIndicator.classList.add('online');
                        statusIndicator.querySelector('span:last-child').textContent = 'Online';
                    }
                });

                peer.on('connection', (connection) => {
                    console.log('Incoming connection from:', connection.peer);
                    
                    // Accept the new connection - update the existing one if needed
                    const peerId = connection.peer;
                    
                    // Get peer info for creating chat entry
                    const peerDigits = PhoneData.peerIdToDigits(peerId);
                    const peerDisplayNumber = PhoneData.formatForDisplay(peerDigits);
                    const peerUser = Auth.getUserByRawPhone(peerDigits);
                    const peerName = peerUser ? peerUser.username : peerDisplayNumber;
                    const peerInitial = peerName.charAt(0).toUpperCase();
                    
                    // Create chat entry if it doesn't exist
                    if (!activeChats[peerId]) {
                        activeChats[peerId] = {
                            id: peerId,
                            name: peerName,
                            phoneNumber: peerDisplayNumber,
                            initial: peerInitial,
                            messages: [],
                            connection: connection,
                            unreadCount: 0
                        };
                        updateChatsList();
                    } else {
                        // Update existing chat connection
                        activeChats[peerId].connection = connection;
                    }
                    
                    // Close old connection if exists and it's different
                    if (conn && conn.open && conn.peer !== peerId) {
                        console.log('Closing old connection to accept new one');
                        conn.close();
                    }
                    
                    // Set up this connection to receive messages
                    setupConnectionForChat(connection, peerId);
                });

                peer.on('error', (err) => {
                    console.error('Peer error:', err);
                    if (err.type === 'peer-unavailable') {
                        elements.status.textContent = 'Status: Online - Ready';
                        if (conn) { conn.close(); conn = null; }
                    } else if (err.type === 'unavailable-id') {
                        addMessage('System: Your number is already in use in another session.', 'system-message');
                        elements.status.textContent = 'Status: ID Conflict';
                    } else {
                        elements.status.textContent = 'Status: Error - ' + (err.type || err.message);
                    }
                });

                peer.on('disconnected', () => {
                    elements.status.textContent = 'Status: Reconnecting...';
                    if (peer && !peer.destroyed) { peer.reconnect(); }
                });
                
                peer.on('close', () => {
                    elements.status.textContent = 'Status: Offline';
                });
                
                // Handle incoming calls via PeerJS
                peer.on('call', async (call) => {
                    console.log('Incoming call from:', call.peer);
                    currentCall = call;
                    
                    // Get caller info
                    const callerDigits = PhoneData.peerIdToDigits(call.peer);
                    const callerUser = Auth.getUserByRawPhone(callerDigits);
                    const callerName = callerUser ? callerUser.username : PhoneData.formatForDisplay(callerDigits);
                    const withVideo = call.metadata?.withVideo || false;
                    
                    // Show incoming call UI
                    showIncomingCall(callerName, withVideo);
                    
                    // Wait for user to accept (localStream will be set when they accept)
                    const checkAccepted = setInterval(() => {
                        if (localStream) {
                            clearInterval(checkAccepted);
                            call.answer(localStream);
                            
                            call.on('stream', (remoteStream) => {
                                document.getElementById('remoteVideo').srcObject = remoteStream;
                                if (withVideo) {
                                    document.getElementById('callVideoContainer').classList.add('active');
                                }
                            });
                            
                            call.on('close', () => {
                                endCall();
                            });
                        }
                    }, 100);
                    
                    // Timeout after 30 seconds
                    setTimeout(() => {
                        clearInterval(checkAccepted);
                        if (!localStream) {
                            call.close();
                            document.getElementById('incomingCallModal').classList.remove('active');
                        }
                    }, 30000);
                });
                
            } catch (error) {
                console.error('Setup error:', error);
                elements.status.textContent = 'Status: Setup failed';
            }
        }

        // Connect to another peer as the joiner
        function connectToPeer(peerId) {
            try {
                if (!peer || !peer.id) {
                    addMessage('System: Not connected to server yet. Please wait a moment and try again.', 'system-message');
                    return false;
                }
                
                conn = peer.connect(peerId, { reliable: true });
                
                if (!conn) {
                    addMessage('System: Failed to create connection.', 'system-message');
                    return false;
                }
                
                setupConnection();
                return true;
            } catch (error) {
                console.error('Connect error:', error);
                addMessage(`System: Connection attempt failed - ${error.message}`, 'system-message');
                return false;
            }
        }

        // Setup connection for a specific chat (handles messages even when not active)
        function setupConnectionForChat(connection, peerId) {
            if (!connection) {
                console.error('setupConnectionForChat: Connection is null');
                return;
            }
            
            connection.on('open', () => {
                console.log('Connection opened with:', peerId);
                
                // Update chat status
                if (activeChats[peerId]) {
                    activeChats[peerId].connection = connection;
                }
                
                // If this is the current chat, update UI
                if (currentChatId === peerId) {
                    document.body.classList.add('connected');
                    elements.status.textContent = 'Connected';
                    document.getElementById('onlineStatus').textContent = 'Connected';
                    document.getElementById('onlineStatus').classList.add('online');
                    document.querySelector('.peer-status').textContent = 'Connected';
                }
                
                updateChatsList();
            });
            
            connection.on('data', (data) => {
                console.log('Received message from:', peerId, data);
                
                // Handle object messages (like unsend/edit notifications)
                if (typeof data === 'object' && data.type) {
                    // Handle special message types here if needed
                    return;
                }
                
                // Store message in the chat
                if (activeChats[peerId]) {
                    const messageId = 'msg-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                    activeChats[peerId].messages.push({
                        msgId: messageId,
                        text: data,
                        className: 'friend-message',
                        time: new Date().toISOString()
                    });
                    activeChats[peerId].lastMessageTime = new Date().toISOString();
                    
                    // If this is NOT the current chat, increment unread count
                    if (currentChatId !== peerId) {
                        activeChats[peerId].unreadCount = (activeChats[peerId].unreadCount || 0) + 1;
                    } else {
                        // If it IS the current chat, display the message
                        addMessage(`Friend: ${data}`, 'friend-message');
                    }
                    
                    saveChatsToStorage();
                    updateChatsList();
                }
            });
            
            connection.on('close', () => {
                console.log('Connection closed with:', peerId);
                if (activeChats[peerId]) {
                    activeChats[peerId].connection = null;
                }
                
                // If this was the current chat, update UI
                if (currentChatId === peerId) {
                    document.body.classList.remove('connected');
                    elements.status.textContent = 'Status: Disconnected';
                    document.getElementById('onlineStatus').textContent = 'Disconnected';
                    document.getElementById('onlineStatus').classList.remove('online');
                    document.querySelector('.peer-status').textContent = 'Offline';
                }
                
                updateChatsList();
            });
            
            connection.on('error', (err) => {
                console.error('Connection error with', peerId, ':', err);
            });
        }

        // Setup the data connection
        function setupConnection() {
            if (!conn) {
                addMessage('System: Connection object is null.', 'system-message');
                return;
            }
            
            conn.on('open', () => {
                console.log('Connection established!');
                document.body.classList.add('connected');
                elements.status.textContent = 'Connected';
                elements.status.style.animation = 'none';
                document.getElementById('onlineStatus').textContent = 'Connected';
                document.getElementById('onlineStatus').classList.add('online');
                
                // Hide empty state when connected
                const emptyState = document.getElementById('chatEmptyState');
                if (emptyState) emptyState.classList.add('hidden');
                
                document.querySelector('.connection-setup').style.display = 'none';
                document.getElementById('messages').innerHTML = '';
                document.querySelector('.chat-header').style.display = 'flex';
                document.getElementById('messages').style.display = 'block';
                document.getElementById('messageControls').style.display = 'flex';
                
                const peerDigits = PhoneData.peerIdToDigits(conn.peer);
                const peerDisplayNumber = PhoneData.formatForDisplay(peerDigits);
                const peerUser = Auth.getUserByRawPhone(peerDigits);
                const peerName = peerUser ? peerUser.username : peerDisplayNumber;
                const peerInitial = peerName.charAt(0).toUpperCase();
                
                document.querySelector('.peer-avatar').textContent = peerInitial;
                document.querySelector('.peer-name').textContent = peerName;
                document.querySelector('.peer-status').textContent = `Connected  ${peerDisplayNumber}`;
                
                currentChatId = conn.peer;
                if (!activeChats[conn.peer]) {
                    activeChats[conn.peer] = {
                        id: conn.peer,
                        name: peerName,
                        phoneNumber: peerDisplayNumber,
                        initial: peerInitial,
                        messages: [],
                        connection: conn
                    };
                } else {
                    // Update connection for existing chat
                    activeChats[conn.peer].connection = conn;
                    // Load existing messages
                    switchToChat(conn.peer);
                }
                updateChatsList();
            });

            conn.on('data', (data) => {
                console.log('Received:', data);
                
                // Handle object messages (like unsend/edit notifications)
                if (typeof data === 'object' && data.type) {
                    // These are handled by the enhanced setupConnection
                    return;
                }
                
                addMessage(`Friend: ${data}`, 'friend-message');
            });

            conn.on('close', () => {
                console.log('Connection closed');
                document.body.classList.remove('connected');
                elements.status.textContent = 'Status: Disconnected';
                document.getElementById('onlineStatus').textContent = 'Disconnected';
                document.getElementById('onlineStatus').classList.remove('online');
                document.querySelector('.peer-status').textContent = 'Offline';
                if (conn) { conn = null; }
            });

            conn.on('error', (err) => {
                console.error('Connection error:', err);
                elements.status.textContent = `Status: Connection error - ${err.message}`;
            });
        }

        // Send a message
        function sendMessage() {
            const text = elements.messageInput.value.trim();
            if (!text) {
                return;
            }
            
            // Check if we have a current chat selected
            if (!currentChatId) {
                addMessage('Please select a chat or dial a number first.', 'system-message');
                return;
            }
            
            // Always add the message to the UI and save it locally
            addMessage(`You: ${text}`, 'your-message');
            elements.messageInput.value = '';
            
            // Try to send if connected, otherwise queue it
            if (conn && conn.open) {
                // Connected - send immediately
                try {
                    conn.send(text);
                } catch (error) {
                    console.error('Send error:', error);
                }
            } else {
                // Not connected - save message and try to reconnect in background
                console.log('User offline. Message saved locally.');
                
                // Try to reconnect in the background (non-blocking)
                if (peer && !peer.destroyed) {
                    try {
                        conn = peer.connect(currentChatId, { reliable: true });
                        
                        conn.on('open', () => {
                            console.log('Reconnected in background');
                            elements.status.textContent = 'Status: Connected';
                            document.querySelector('.peer-status').textContent = 'Connected';
                            document.getElementById('onlineStatus').classList.add('online');
                            document.getElementById('onlineStatus').querySelector('span:last-child').textContent = 'Online';
                            
                            // Update the connection in activeChats
                            if (activeChats[currentChatId]) {
                                activeChats[currentChatId].connection = conn;
                            }
                            
                            // Setup connection handlers
                            setupConnection();
                            
                            // Try to send the message now
                            try {
                                conn.send(text);
                            } catch (e) {
                                console.error('Failed to send queued message:', e);
                            }
                        });
                        
                        conn.on('error', (err) => {
                            console.log('Background reconnect failed - user still offline');
                        });
                        
                    } catch (error) {
                        console.log('Could not attempt reconnect:', error);
                    }
                }
            }
        }
        
        function updateChatsList() {
            const chatsList = document.getElementById('chatsList');
            if (!chatsList) return;
            
            // Clear the list
            chatsList.innerHTML = '';
            
            // Check if we have any chats
            if (Object.keys(activeChats).length === 0) {
                chatsList.innerHTML = '<div class="empty-chats" style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px 0;">No recent chats</div>';
                return;
            }
            
            // Sort chats by last message time (most recent first)
            const sortedChats = Object.entries(activeChats).sort((a, b) => {
                const timeA = a[1].lastMessageTime || '1970-01-01';
                const timeB = b[1].lastMessageTime || '1970-01-01';
                return new Date(timeB) - new Date(timeA);
            });
            
            // Add each chat to the list
            for (const [chatId, chat] of sortedChats) {
                const chatItem = document.createElement('div');
                chatItem.className = `chat-item ${chatId === currentChatId ? 'active' : ''}`;
                chatItem.dataset.chatId = chatId;
                
                // Get the last message for preview
                let lastMessage = 'No messages yet';
                let lastTime = '';
                if (chat.messages && chat.messages.length > 0) {
                    const lastMsg = chat.messages[chat.messages.length - 1];
                    lastMessage = lastMsg.text.replace(/^(You: |Friend: )/, '');
                    if (lastMessage.length > 25) {
                        lastMessage = lastMessage.substring(0, 25) + '...';
                    }
                    // Format time
                    const msgDate = new Date(lastMsg.time);
                    const today = new Date();
                    if (msgDate.toDateString() === today.toDateString()) {
                        lastTime = msgDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    } else {
                        lastTime = msgDate.toLocaleDateString([], {month: 'short', day: 'numeric'});
                    }
                }
                
                // Show unread badge if any
                const unreadBadge = chat.unreadCount > 0 ? `<span class="unread-badge">${chat.unreadCount}</span>` : '';
                
                // Show save button only if not already a saved contact
                const saveBtn = !chat.isSavedContact ? 
                    `<button class="chat-action-btn save" onclick="event.stopPropagation(); saveContactFromChat('${chatId}')" title="Save Contact"></button>` : '';
                
                chatItem.innerHTML = `
                    <div class="chat-avatar">${chat.initial}</div>
                    <div class="chat-details">
                        <div class="chat-name">${chat.name}</div>
                        <div class="chat-preview">${lastMessage}</div>
                    </div>
                    <span class="chat-time">${lastTime}</span>
                    ${unreadBadge}
                    <div class="chat-actions">
                        ${saveBtn}
                        <button class="chat-action-btn delete" onclick="event.stopPropagation(); deleteChat('${chatId}')" title="Delete Chat"></button>
                    </div>
                `;
                
                // Add click handler to switch chats
                chatItem.addEventListener('click', () => {
                    switchToChat(chatId);
                });
                
                chatsList.appendChild(chatItem);
            }
        }
        
        function switchToChat(chatId) {
            if (!activeChats[chatId]) return;
            
            // Hide empty state and Start a Chat interface
            const emptyState = document.getElementById('chatEmptyState');
            if (emptyState) emptyState.classList.add('hidden');
            const startChatInterface = document.getElementById('startChatInterface');
            if (startChatInterface) startChatInterface.style.display = 'none';
            
            // Show messages and controls
            document.getElementById('messages').style.display = 'block';
            document.querySelector('.chat-header').style.display = 'flex';
            document.getElementById('messageControls').style.display = 'flex';
            
            // Set current chat
            currentChatId = chatId;
            conn = activeChats[chatId].connection;
            activeChats[chatId].unreadCount = 0;
            
            // Update UI
            document.querySelector('.peer-avatar').textContent = activeChats[chatId].initial;
            document.querySelector('.peer-name').textContent = activeChats[chatId].name;
            
            // Check if we need to reconnect
            const isConnected = conn && conn.open;
            if (!isConnected) {
                // Auto-reconnect to this peer
                document.querySelector('.peer-status').textContent = 'Connecting...';
                reconnectToChat(chatId);
            } else {
                document.querySelector('.peer-status').textContent = 'Connected';
            }
            
            // Clear and load messages
            const messages = document.getElementById('messages');
            messages.innerHTML = '';
            
            // Add all messages from this chat
            activeChats[chatId].messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${msg.className}`;
                
                // Add message ID for edit/unsend functionality
                if (msg.msgId) {
                    messageDiv.dataset.msgId = msg.msgId;
                }
                
                // Handle unsent messages
                if (msg.unsent) {
                    messageDiv.classList.add('unsent');
                }
                
                if (msg.className === 'system-message') {
                    messageDiv.innerHTML = `<div class="system-alert">${msg.text}</div>`;
                } else {
                    const textSpan = document.createElement('span');
                    if (msg.unsent) {
                        textSpan.textContent = msg.className === 'your-message' ? 'You unsent this message' : 'This message was unsent';
                    } else if (msg.edited) {
                        textSpan.innerHTML = msg.text + '<span class="edited-label">(edited)</span>';
                    } else {
                        textSpan.textContent = msg.text;
                    }
                    messageDiv.appendChild(textSpan);
                    
                    const timeSpan = document.createElement('span');
                    timeSpan.className = 'time';
                    const msgDate = new Date(msg.time);
                    timeSpan.textContent = msgDate.toLocaleTimeString();
                    messageDiv.appendChild(timeSpan);
                }
                
                messages.appendChild(messageDiv);
            });
            
            messages.scrollTop = messages.scrollHeight;
            updateChatsList();
        }
        
        // Reconnect to a chat when tapping on it
        function reconnectToChat(peerId) {
            if (!peer || peer.destroyed) {
                document.querySelector('.peer-status').textContent = 'Error: Not online';
                return;
            }
            
            console.log('Reconnecting to:', peerId);
            
            try {
                conn = peer.connect(peerId, { reliable: true });
                
                conn.on('open', () => {
                    console.log('Reconnected to:', peerId);
                    document.querySelector('.peer-status').textContent = 'Connected';
                    document.body.classList.add('connected');
                    elements.status.textContent = 'Status: Connected';
                    
                    if (activeChats[peerId]) {
                        activeChats[peerId].connection = conn;
                    }
                    
                    setupConnection();
                });
                
                conn.on('error', (err) => {
                    console.error('Reconnect error:', err);
                    document.querySelector('.peer-status').textContent = 'User offline';
                });
                
            } catch (err) {
                console.error('Failed to reconnect:', err);
                document.querySelector('.peer-status').textContent = 'Connection failed';
            }
        }

        // Add message to the chat
        function addMessage(text, className = '', msgId = null) {
            const messages = document.getElementById('messages');
            if (!messages) return null;
            
            // Generate unique message ID if not provided
            const messageId = msgId || Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            messageDiv.dataset.msgId = messageId;
            
            if (className === 'system-message') {
                messageDiv.innerHTML = `<div class="system-alert">${text}</div>`;
            } else {
                const textSpan = document.createElement('span');
                textSpan.textContent = text;
                messageDiv.appendChild(textSpan);
                
                // Add timestamp
                const timeSpan = document.createElement('span');
                timeSpan.className = 'time';
                const now = new Date();
                timeSpan.textContent = now.toLocaleTimeString();
                messageDiv.appendChild(timeSpan);
            }
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
            
            // Store message in active chats if we have a current chat (skip system messages)
            if (currentChatId && activeChats[currentChatId] && className !== 'system-message') {
                activeChats[currentChatId].messages.push({
                    msgId: messageId,
                    text: text,
                    className: className,
                    time: new Date().toISOString()
                });
                activeChats[currentChatId].lastMessageTime = new Date().toISOString();
                
                // Save to localStorage immediately
                saveChatsToStorage();
                
                // Update chat preview in sidebar
                updateChatsList();
            }
            
            return messageId;
        }

        // Cleanup function to reset connection (keeps peer alive for receiving calls)
        function cleanup(destroyPeer = false) {
            if (conn) {
                conn.close();
                conn = null;
            }
            
            document.body.classList.remove('connected');
            elements.status.style.animation = 'none';
            
            // Don't show the old connection setup - we use the new interface now
            // document.querySelector('.connection-setup').style.display = 'block';
            
            // Keep chat interface visible but update status
            document.querySelector('.peer-name').textContent = 'Not Connected';
            document.querySelector('.peer-status').textContent = 'Dial a number to start a chat';
            document.getElementById('messages').innerHTML = '';
            
            // Show empty state again
            const emptyState = document.getElementById('chatEmptyState');
            if (emptyState) emptyState.classList.remove('hidden');
            currentChatId = null;
            
            if (destroyPeer && peer) {
                peer.destroy();
                peer = null;
                elements.status.textContent = 'Status: Offline';
                const statusIndicator = document.getElementById('onlineStatus');
                if (statusIndicator) {
                    statusIndicator.classList.remove('online');
                    statusIndicator.querySelector('span:last-child').textContent = 'Offline';
                }
            } else if (peer && peer.open) {
                elements.status.textContent = 'Status: Online - Ready to receive calls';
                addMessage('Ready to chat. Enter a number to start.', 'system-message');
            } else {
                // Re-initialize peer with user's phone number
                const userData = Auth.getCurrentUserData();
                if (userData) {
                    const rawDigits = userData.phoneRaw || PhoneData.normalizeToDigits(userData.phoneNumber || '');
                    if (rawDigits) {
                        const peerId = PhoneData.digitsToPeerId(rawDigits);
                        setupPeer(peerId, true);
                    }
                }
            }
        }

        // Show/hide auth forms
        authElements.showSignup.addEventListener('click', (e) => {
            e.preventDefault();
            authElements.loginForm.style.display = 'none';
            authElements.signupForm.style.display = 'flex';
        });

        authElements.showLogin.addEventListener('click', (e) => {
            authElements.signupForm.style.display = 'none';
            authElements.loginForm.style.display = 'flex';
        });

        // Handle Login
        authElements.loginBtn.addEventListener('click', () => {
            const username = authElements.loginUsername.value.trim();
            const password = authElements.loginPassword.value.trim();

            try {
                if (!username || !password) {
                    throw new Error('Please fill in all fields');
                }
                if (username.length < 3) {
                    throw new Error('Username must be at least 3 characters');
                }
                if (password.length < 6) {
                    throw new Error('Password must be at least 6 characters');
                }
                Auth.login(username, password);
                Auth.setCurrentUser(username);
                setupDashboard(username);
                elements.intro.style.display = 'none';
                elements.chatPage.style.display = 'block';
                addMessage(`Welcome back, ${username}!`, 'system-message');
                // Clear form
                authElements.loginUsername.value = '';
                authElements.loginPassword.value = '';
            } catch (error) {
                alert(error.message);
            }
        });

        // Handle signup
        authElements.signupBtn.addEventListener('click', () => {
            const username = authElements.signupUsername.value.trim();
            const password = authElements.signupPassword.value.trim();
            const country = document.getElementById('countrySelect').value;
            const areaCode = document.getElementById('areaCodeSelect').value;

            try {
                if (!username || !password) {
                    throw new Error('Please fill in all fields');
                }
                if (username.length < 3) {
                    throw new Error('Username must be at least 3 characters');
                }
                if (password.length < 6) {
                    throw new Error('Password must be at least 6 characters');
                }
                if (!country || !areaCode) {
                    throw new Error('Please select a country and area code');
                }
                const phoneData = Auth.register(username, password, country, areaCode);
                Auth.setCurrentUser(username);
                setupDashboard(username);
                elements.intro.style.display = 'none';
                elements.chatPage.style.display = 'block';
                addMessage(`Welcome, ${username}! Your number is: ${phoneData.display} (dial: ${phoneData.raw})`, 'system-message');
                // Clear form
                authElements.signupUsername.value = '';
                authElements.signupPassword.value = '';
                document.getElementById('countrySelect').value = '';
                document.getElementById('areaCodeSelect').value = '';
                document.getElementById('areaCodeSelect').disabled = true;
            } catch (error) {
                alert(error.message);
            }
        });

        // Dial/Call button handler
        elements.dialBtn.addEventListener('click', () => {
            dialNumber('call');
        });

        // Text button handler
        document.getElementById('textBtn').addEventListener('click', () => {
            dialNumber('text');
        });

        // Main Call button handler (in Start a Chat interface)
        document.getElementById('mainCallBtn').addEventListener('click', () => {
            dialNumberFromMain('call');
        });

        // Main Text button handler (in Start a Chat interface)
        document.getElementById('mainTextBtn').addEventListener('click', () => {
            dialNumberFromMain('text');
        });

        // Dial function for main Start a Chat interface
        function dialNumberFromMain(mode) {
            const dialInput = document.getElementById('mainDialInput').value.trim();
            if (!dialInput) {
                alert('Please enter a phone number.');
                return;
            }
            
            // Hide the Start a Chat interface
            document.getElementById('startChatInterface').style.display = 'none';
            document.getElementById('messages').style.display = 'block';
            
            // Show chat header and message controls
            document.querySelector('.chat-header').style.display = 'flex';
            document.getElementById('messageControls').style.display = 'flex';
            
            // Normalize the input to digits only, then create peer ID
            const rawDigits = PhoneData.normalizeToDigits(dialInput);
            const peerId = PhoneData.digitsToPeerId(rawDigits);
            
            // Check if user exists with this number
            const targetUser = Auth.getUserByRawPhone(rawDigits);
            const displayNumber = targetUser ? targetUser.phoneNumber : PhoneData.formatForDisplay(rawDigits);
            const peerName = targetUser ? targetUser.username : displayNumber;
            const peerInitial = peerName.charAt(0).toUpperCase();
            
            // Hide empty state
            const emptyState = document.getElementById('chatEmptyState');
            if (emptyState) emptyState.classList.add('hidden');
            
            if (mode === 'call') {
                // For calls, we need to first establish connection, then initiate call
                elements.status.textContent = `Status: Calling ${displayNumber}...`;
                
                // Create or update chat entry
                if (!activeChats[peerId]) {
                    activeChats[peerId] = {
                        id: peerId,
                        name: peerName,
                        phoneNumber: displayNumber,
                        initial: peerInitial,
                        messages: [],
                        connection: null
                    };
                    updateChatsList();
                }
                currentChatId = peerId;
                
                // Show call modal immediately
                document.getElementById('callModal').classList.add('active');
                document.getElementById('callAvatar').textContent = peerInitial;
                document.getElementById('callName').textContent = peerName;
                document.getElementById('callStatus').textContent = 'Calling...';
                document.getElementById('callTimer').textContent = '00:00';
                document.getElementById('callVideoContainer').classList.remove('active');
                document.getElementById('toggleVideoBtn').style.display = 'none';
                
                // Connect and then start call
                connectToPeer(peerId);
                
                // Start the actual voice call after a short delay to allow connection
                setTimeout(() => {
                    initiateCallDirect(peerId, peerName, peerInitial, false);
                }, 1000);
                
            } else {
                // Text mode - just connect
                elements.status.textContent = `Status: Connecting to ${displayNumber}...`;
                connectToPeer(peerId);
            }
            
            // Clear the input
            document.getElementById('mainDialInput').value = '';
        }

        // Shared dial function for both Call and Text
        function dialNumber(mode) {
            const dialInput = elements.dialInput.value.trim();
            if (!dialInput) {
                addMessage('System: Please enter a phone number.', 'system-message');
                return;
            }
            
            // Normalize the input to digits only, then create peer ID
            const rawDigits = PhoneData.normalizeToDigits(dialInput);
            const peerId = PhoneData.digitsToPeerId(rawDigits);
            
            // Check if user exists with this number
            const targetUser = Auth.getUserByRawPhone(rawDigits);
            const displayNumber = targetUser ? targetUser.phoneNumber : PhoneData.formatForDisplay(rawDigits);
            const peerName = targetUser ? targetUser.username : displayNumber;
            const peerInitial = peerName.charAt(0).toUpperCase();
            
            // Hide empty state
            const emptyState = document.getElementById('chatEmptyState');
            if (emptyState) emptyState.classList.add('hidden');
            
            if (mode === 'call') {
                // For calls, we need to first establish connection, then initiate call
                elements.status.textContent = `Status: Calling ${displayNumber}...`;
                
                // Create or update chat entry
                if (!activeChats[peerId]) {
                    activeChats[peerId] = {
                        id: peerId,
                        name: peerName,
                        phoneNumber: displayNumber,
                        initial: peerInitial,
                        messages: [],
                        connection: null
                    };
                    updateChatsList();
                }
                currentChatId = peerId;
                
                // Show call modal immediately
                document.getElementById('callModal').classList.add('active');
                document.getElementById('callAvatar').textContent = peerInitial;
                document.getElementById('callName').textContent = peerName;
                document.getElementById('callStatus').textContent = 'Calling...';
                document.getElementById('callTimer').textContent = '00:00';
                document.getElementById('callVideoContainer').classList.remove('active');
                document.getElementById('toggleVideoBtn').style.display = 'none';
                
                // Connect and then start call
                connectToPeer(peerId);
                
                // Start the actual voice call after a short delay to allow connection
                setTimeout(() => {
                    initiateCallDirect(peerId, peerName, peerInitial, false);
                }, 1000);
                
            } else {
                // Text mode - just connect
                elements.status.textContent = `Status: Connecting to ${displayNumber}...`;
                connectToPeer(peerId);
            }
            
            // Clear the input
            elements.dialInput.value = '';
        }
        
        // Direct call initiation for dialer
        async function initiateCallDirect(peerId, peerName, peerInitial, withVideo) {
            try {
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: withVideo
                });
                
                // Make the call using PeerJS
                currentCall = peer.call(peerId, localStream);
                
                if (!currentCall) {
                    document.getElementById('callStatus').textContent = 'Call failed - user offline';
                    setTimeout(endCall, 2000);
                    return;
                }
                
                currentCall.on('stream', (remoteStream) => {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                    document.getElementById('callStatus').textContent = 'Connected';
                    startCallTimer();
                });
                
                currentCall.on('close', () => {
                    endCall();
                });
                
                currentCall.on('error', (err) => {
                    console.error('Call error:', err);
                    document.getElementById('callStatus').textContent = 'Call failed';
                    setTimeout(endCall, 2000);
                });
                
                // Play ringing sound
                playRingtone();
                
                // Timeout if no answer
                setTimeout(() => {
                    if (document.getElementById('callStatus').textContent === 'Calling...') {
                        document.getElementById('callStatus').textContent = 'No answer';
                        setTimeout(endCall, 2000);
                    }
                }, 30000);
                
            } catch (err) {
                console.error('Failed to get media:', err);
                document.getElementById('callStatus').textContent = 'Microphone access denied';
                setTimeout(endCall, 2000);
            }
        }

        elements.sendBtn.addEventListener('click', sendMessage);
        
        // Allow sending with Enter key
        elements.messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Prevent accidental navigation
        window.addEventListener('beforeunload', (e) => {
            if (conn && conn.open) {
                const message = 'You are connected to a chat. Leaving will disconnect you.';
                e.returnValue = message;
                return message;
            }
        });
        
        // Cleanup when page closes
        window.addEventListener('unload', cleanup);

        // Populate country dropdown
        function populateCountries() {
            const countrySelect = document.getElementById('countrySelect');
            for (const [code, data] of Object.entries(PhoneData.countries)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${data.flag} ${data.name} (${data.code})`;
                countrySelect.appendChild(option);
            }
        }

        // Handle country selection
        document.getElementById('countrySelect').addEventListener('change', (e) => {
            const areaCodeSelect = document.getElementById('areaCodeSelect');
            const country = e.target.value;
            
            // Clear and disable area code if no country selected
            areaCodeSelect.innerHTML = '<option value="">Select Area Code</option>';
            
            if (!country) {
                areaCodeSelect.disabled = true;
                return;
            }
            
            // Populate area codes for selected country
            const countryData = PhoneData.countries[country];
            for (const [code, name] of Object.entries(countryData.areaCodes)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} - ${name}`;
                areaCodeSelect.appendChild(option);
            }
            
            areaCodeSelect.disabled = false;
        });

        // Initialize countries on page load
        populateCountries();

        // Check for existing session on page load (auto-login)
        const existingUser = Auth.getCurrentUser();
        if (existingUser) {
            const userData = Auth.getCurrentUserData();
            if (userData) {
                // User is already logged in, restore session
                setupDashboard(existingUser);
                elements.intro.style.display = 'none';
                elements.chatPage.style.display = 'block';
                addMessage(`Welcome back, ${existingUser}!`, 'system-message');
            }
        }

        // Mobile sidebar toggle
        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        
        function toggleSidebar() {
            sidebar.classList.toggle('active');
            sidebarOverlay.classList.toggle('active');
        }
        
        function closeSidebar() {
            sidebar.classList.remove('active');
            sidebarOverlay.classList.remove('active');
        }
        
        sidebarToggle.addEventListener('click', toggleSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);
        
        // Close sidebar on swipe left (mobile)
        let sidebarTouchStartX = 0;
        let sidebarTouchEndX = 0;
        
        sidebar.addEventListener('touchstart', (e) => {
            sidebarTouchStartX = e.changedTouches[0].screenX;
        }, { passive: true });
        
        sidebar.addEventListener('touchend', (e) => {
            sidebarTouchEndX = e.changedTouches[0].screenX;
            handleSidebarSwipe();
        }, { passive: true });
        
        function handleSidebarSwipe() {
            if (sidebarTouchStartX - sidebarTouchEndX > 50) {
                // Swiped left
                closeSidebar();
            }
        }

        // Handle sign out
        authElements.signOutBtn.addEventListener('click', () => {
            Auth.logout();
            cleanup(true); // Destroy peer on sign out
            elements.chatPage.style.display = 'none';
            elements.intro.style.display = 'block';
            authElements.loginForm.style.display = 'flex';
            authElements.signupForm.style.display = 'none';
            authElements.loginUsername.value = '';
            authElements.loginPassword.value = '';
            elements.messages.innerHTML = '';
        });

        // ============ SETTINGS FUNCTIONS ============
        
        function openSettings() {
            const modal = document.getElementById('settingsModal');
            const userData = Auth.getCurrentUserData();
            const username = Auth.getCurrentUser();
            
            // Populate settings data
            if (userData) {
                document.getElementById('settingsPhoneDisplay').textContent = userData.phoneNumber || 'Not set';
                document.getElementById('settingsPhoneRaw').textContent = userData.phoneRaw || '';
                document.getElementById('settingsUsername').textContent = username;
                document.getElementById('settingsStatus').textContent = peer && peer.open ? 'Online' : 'Offline';
                document.getElementById('settingsStatus').className = 'value ' + (peer && peer.open ? 'online' : '');
            }
            
            // Populate settings country dropdown
            populateSettingsCountries();
            
            modal.classList.add('active');
        }
        
        function closeSettings() {
            document.getElementById('settingsModal').classList.remove('active');
            document.getElementById('changeNumberSection').style.display = 'none';
        }
        
        function populateSettingsCountries() {
            const countrySelect = document.getElementById('settingsCountrySelect');
            countrySelect.innerHTML = '<option value="">Select Country</option>';
            for (const [code, data] of Object.entries(PhoneData.countries)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${data.flag} ${data.name} (${data.code})`;
                countrySelect.appendChild(option);
            }
        }
        
        // Settings button click
        document.getElementById('settingsBtn').addEventListener('click', openSettings);
        
        // Copy number button
        document.getElementById('copyNumberBtn').addEventListener('click', () => {
            const rawNumber = document.getElementById('settingsPhoneRaw').textContent;
            navigator.clipboard.writeText(rawNumber).then(() => {
                const btn = document.getElementById('copyNumberBtn');
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = 'Copy', 2000);
            });
        });
        
        // Change number button
        document.getElementById('changeNumberBtn').addEventListener('click', () => {
            document.getElementById('changeNumberSection').style.display = 'block';
        });
        
        // Cancel change button
        document.getElementById('cancelChangeBtn').addEventListener('click', () => {
            document.getElementById('changeNumberSection').style.display = 'none';
            document.getElementById('settingsCountrySelect').value = '';
            document.getElementById('settingsAreaCodeSelect').innerHTML = '<option value="">Select Area Code</option>';
            document.getElementById('settingsAreaCodeSelect').disabled = true;
        });
        
        // Settings country selection
        document.getElementById('settingsCountrySelect').addEventListener('change', (e) => {
            const areaCodeSelect = document.getElementById('settingsAreaCodeSelect');
            const country = e.target.value;
            
            areaCodeSelect.innerHTML = '<option value="">Select Area Code</option>';
            
            if (!country) {
                areaCodeSelect.disabled = true;
                return;
            }
            
            const countryData = PhoneData.countries[country];
            for (const [code, name] of Object.entries(countryData.areaCodes)) {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${code} - ${name}`;
                areaCodeSelect.appendChild(option);
            }
            
            areaCodeSelect.disabled = false;
        });
        
        // Generate new number
        document.getElementById('generateNewNumberBtn').addEventListener('click', () => {
            const country = document.getElementById('settingsCountrySelect').value;
            const areaCode = document.getElementById('settingsAreaCodeSelect').value;
            
            if (!country || !areaCode) {
                alert('Please select a country and area code');
                return;
            }
            
            const username = Auth.getCurrentUser();
            const phoneData = Auth.changePhoneNumber(username, country, areaCode);
            
            if (phoneData) {
                // Update displays
                document.getElementById('settingsPhoneDisplay').textContent = phoneData.display;
                document.getElementById('settingsPhoneRaw').textContent = phoneData.raw;
                document.getElementById('myPhoneNumber').textContent = phoneData.display;
                document.getElementById('myPhoneRaw').textContent = `Dial: ${phoneData.raw}`;
                
                // Hide change section
                document.getElementById('changeNumberSection').style.display = 'none';
                
                // Reconnect with new peer ID
                if (peer) {
                    peer.destroy();
                }
                const peerId = PhoneData.digitsToPeerId(phoneData.raw);
                setupPeer(peerId, true);
                
                addMessage(`Your number has been changed to ${phoneData.display}`, 'system-message');
            }
        });
        
        // Clear all chats
        document.getElementById('clearChatsBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to clear all chats? This cannot be undone.')) {
                activeChats = {};
                updateChatsList();
                document.getElementById('messages').innerHTML = '';
                addMessage('All chats have been cleared.', 'system-message');
            }
        });
        
        // Delete account
        document.getElementById('deleteAccountBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to delete your account? This cannot be undone.')) {
                const username = Auth.getCurrentUser();
                Auth.deleteAccount(username);
                Auth.logout();
                cleanup();
                elements.chatPage.style.display = 'none';
                elements.intro.style.display = 'block';
                authElements.loginForm.style.display = 'flex';
                alert('Your account has been deleted.');
            }
        });
        
        // Close modal when clicking outside
        document.getElementById('settingsModal').addEventListener('click', (e) => {
            if (e.target.id === 'settingsModal') {
                closeSettings();
            }
        });
        
        // Show dialer function - now shows in main chat window
        function showDialer() {
            // Hide empty state and messages
            const emptyState = document.getElementById('chatEmptyState');
            if (emptyState) emptyState.classList.add('hidden');
            document.getElementById('messages').style.display = 'none';
            
            // Hide chat header and message controls
            document.querySelector('.chat-header').style.display = 'none';
            document.getElementById('messageControls').style.display = 'none';
            
            // Show the start chat interface
            const startChatInterface = document.getElementById('startChatInterface');
            if (startChatInterface) {
                startChatInterface.style.display = 'flex';
                document.getElementById('mainDialInput').focus();
            }
        }
        
        // Show home view - returns to welcome screen without disconnecting
        function showHomeView() {
            // Clear current chat view but keep connections alive
            currentChatId = null;
            if (conn) {
                conn = null; // Clear the active connection reference but don't close it
            }
            
            // Hide Start a Chat interface if it's showing
            const startChatInterface = document.getElementById('startChatInterface');
            if (startChatInterface) startChatInterface.style.display = 'none';
            
            // Show the empty state (welcome screen)
            const emptyState = document.getElementById('chatEmptyState');
            if (emptyState) emptyState.classList.remove('hidden');
            
            // Show messages container and controls
            document.getElementById('messages').style.display = 'block';
            document.getElementById('messages').innerHTML = '';
            
            // Show chat header and message controls
            document.querySelector('.chat-header').style.display = 'flex';
            document.getElementById('messageControls').style.display = 'flex';
            
            // Reset header
            document.querySelector('.peer-name').textContent = 'Not Connected';
            document.querySelector('.peer-status').textContent = 'Select a chat or dial a number to begin';
            document.querySelector('.peer-avatar').textContent = '';
            
            // Keep status as online
            document.body.classList.remove('connected');
            
            // All connections remain active in activeChats for receiving messages
            console.log('Returned to home view. All connections remain active.');
        }
        
        // ============ NEW FEATURES ============
        
        // Emoji Data
        const emojis = {
            smileys: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            gestures: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            hearts: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', ''],
            objects: ['', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '', '']
        };
        
        // Initialize emoji picker
        function initEmojiPicker() {
            const emojiGrid = document.getElementById('emojiGrid');
            if (!emojiGrid) return;
            
            emojiGrid.innerHTML = '';
            
            // Add all emoji categories
            Object.values(emojis).flat().forEach(emoji => {
                const span = document.createElement('span');
                span.className = 'emoji-item';
                span.textContent = emoji;
                span.onclick = () => insertEmoji(emoji);
                emojiGrid.appendChild(span);
            });
        }
        
        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            const start = input.selectionStart;
            const end = input.selectionEnd;
            const text = input.value;
            input.value = text.substring(0, start) + emoji + text.substring(end);
            input.focus();
            input.selectionStart = input.selectionEnd = start + emoji.length;
            document.getElementById('emojiPanel').classList.remove('active');
        }
        
        // Toggle emoji panel
        document.getElementById('emojiBtn').addEventListener('click', () => {
            const panel = document.getElementById('emojiPanel');
            panel.classList.toggle('active');
            if (panel.classList.contains('active')) {
                initEmojiPicker();
            }
        });
        
        // Close emoji panel when clicking outside
        document.addEventListener('click', (e) => {
            const panel = document.getElementById('emojiPanel');
            const btn = document.getElementById('emojiBtn');
            if (!panel.contains(e.target) && e.target !== btn) {
                panel.classList.remove('active');
            }
        });
        
        // ============ TYPING INDICATOR ============
        let typingTimeout = null;
        let isTyping = false;
        
        function sendTypingIndicator(typing) {
            if (conn && conn.open) {
                conn.send({ type: 'typing', isTyping: typing });
            }
        }
        
        function showTypingIndicator(show) {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.classList.toggle('active', show);
            }
        }
        
        // Listen for typing in message input
        document.getElementById('messageInput').addEventListener('input', () => {
            if (!isTyping) {
                isTyping = true;
                sendTypingIndicator(true);
            }
            
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => {
                isTyping = false;
                sendTypingIndicator(false);
            }, 1500);
        });
        
        // ============ IMAGE/FILE SHARING ============
        document.getElementById('attachBtn').addEventListener('click', () => {
            document.getElementById('fileInput').click();
        });
        
        document.getElementById('fileInput').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                alert('Only images are supported');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('File too large. Max 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (event) => {
                const imageData = event.target.result;
                sendImage(imageData);
            };
            reader.readAsDataURL(file);
            e.target.value = '';
        });
        
        function sendImage(imageData) {
            if (!conn || !conn.open) {
                addMessage('Not connected. Cannot send image.', 'system-message');
                return;
            }
            
            try {
                conn.send({ type: 'image', data: imageData });
                addImageMessage(imageData, 'your-message');
            } catch (error) {
                console.error('Failed to send image:', error);
                addMessage('Failed to send image.', 'system-message');
            }
        }
        
        function addImageMessage(imageData, className) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            
            const img = document.createElement('img');
            img.src = imageData;
            img.className = 'message-image';
            img.onclick = () => openImageModal(imageData);
            
            const timeSpan = document.createElement('span');
            timeSpan.className = 'time';
            timeSpan.textContent = new Date().toLocaleTimeString();
            
            messageDiv.appendChild(img);
            messageDiv.appendChild(timeSpan);
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
            
            // Play sound for received images
            if (className === 'friend-message') {
                playNotificationSound();
            }
        }
        
        function openImageModal(src) {
            document.getElementById('modalImage').src = src;
            document.getElementById('imageModal').classList.add('active');
        }
        
        function closeImageModal() {
            document.getElementById('imageModal').classList.remove('active');
        }
        
        // ============ MESSAGE SEARCH ============
        document.getElementById('searchBtn').addEventListener('click', () => {
            const container = document.getElementById('searchContainer');
            container.classList.toggle('active');
            if (container.classList.contains('active')) {
                document.getElementById('searchInput').focus();
            }
        });
        
        function searchMessages() {
            const query = document.getElementById('searchInput').value.toLowerCase().trim();
            if (!query) return;
            
            const messages = document.querySelectorAll('#messages .message');
            let found = 0;
            
            messages.forEach(msg => {
                msg.classList.remove('highlight');
                if (msg.textContent.toLowerCase().includes(query)) {
                    msg.classList.add('highlight');
                    found++;
                    if (found === 1) {
                        msg.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
            });
            
            if (found === 0) {
                addMessage(`No messages found for "${query}"`, 'system-message');
            }
        }
        
        function closeSearch() {
            document.getElementById('searchContainer').classList.remove('active');
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('#messages .message').forEach(msg => {
                msg.classList.remove('highlight');
            });
        }
        
        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                searchMessages();
            }
        });
        
        // ============ NOTIFICATION SOUNDS ============
        let soundEnabled = true;
        
        function playNotificationSound() {
            if (!soundEnabled) return;
            
            // Create a simple beep using Web Audio API
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.3);
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        
        // ============ CONTACTS SYSTEM ============
        let contacts = JSON.parse(localStorage.getItem('quickwrap_contacts') || '[]');
        
        function saveContactsToStorage() {
            localStorage.setItem('quickwrap_contacts', JSON.stringify(contacts));
        }
        
        function openAddContactModal() {
            document.getElementById('addContactModal').classList.add('active');
        }
        
        function closeAddContactModal() {
            document.getElementById('addContactModal').classList.remove('active');
            document.getElementById('contactName').value = '';
            document.getElementById('contactNumber').value = '';
        }
        
        function saveContact() {
            const name = document.getElementById('contactName').value.trim();
            const number = document.getElementById('contactNumber').value.trim();
            
            if (!name || !number) {
                alert('Please fill in all fields');
                return;
            }
            
            const rawNumber = PhoneData.normalizeToDigits(number);
            contacts.push({ name, number: rawNumber, displayNumber: PhoneData.formatForDisplay(rawNumber) });
            saveContactsToStorage();
            closeAddContactModal();
            addMessage(`Contact "${name}" saved!`, 'system-message');
        }
        
        // ============ THEME TOGGLE ============
        let isDarkTheme = localStorage.getItem('quickwrap_theme') !== 'light';
        
        function applyTheme() {
            document.body.classList.toggle('light-theme', !isDarkTheme);
        }
        
        function toggleTheme() {
            isDarkTheme = !isDarkTheme;
            localStorage.setItem('quickwrap_theme', isDarkTheme ? 'dark' : 'light');
            applyTheme();
        }
        
        // Apply saved theme on load
        applyTheme();
        
        // Sound toggle function
        function toggleSound() {
            soundEnabled = !soundEnabled;
            localStorage.setItem('quickwrap_sound', soundEnabled ? 'on' : 'off');
            document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
        }
        
        // Initialize sound setting
        soundEnabled = localStorage.getItem('quickwrap_sound') !== 'off';
        
        // Update toggle states on settings open
        const originalOpenSettings = openSettings;
        openSettings = function() {
            originalOpenSettings();
            document.getElementById('themeToggle').classList.toggle('active', !isDarkTheme);
            document.getElementById('soundToggle').classList.toggle('active', soundEnabled);
        };
        
        // ============ MESSAGE REACTIONS ============
        const reactionEmojis = ['', '', '', '', '', ''];
        let messageIdCounter = 0;
        
        function addReactionToMessage(messageId, emoji) {
            const msgEl = document.querySelector(`[data-msg-id="${messageId}"]`);
            if (!msgEl) return;
            
            let reactionsDiv = msgEl.querySelector('.message-reactions');
            if (!reactionsDiv) {
                reactionsDiv = document.createElement('div');
                reactionsDiv.className = 'message-reactions';
                msgEl.appendChild(reactionsDiv);
            }
            
            // Check if reaction already exists
            let existingReaction = reactionsDiv.querySelector(`[data-emoji="${emoji}"]`);
            if (existingReaction) {
                const countEl = existingReaction.querySelector('.count');
                countEl.textContent = parseInt(countEl.textContent) + 1;
            } else {
                const reaction = document.createElement('span');
                reaction.className = 'reaction';
                reaction.dataset.emoji = emoji;
                reaction.innerHTML = `${emoji}<span class="count">1</span>`;
                reactionsDiv.appendChild(reaction);
            }
            
            // Send reaction to peer
            if (conn && conn.open) {
                conn.send({ type: 'reaction', messageId, emoji });
            }
        }
        
        function showReactionPicker(messageId) {
            // Remove any existing pickers
            document.querySelectorAll('.reaction-picker.active').forEach(p => p.classList.remove('active'));
            
            const msgEl = document.querySelector(`[data-msg-id="${messageId}"]`);
            if (!msgEl) return;
            
            let picker = msgEl.querySelector('.reaction-picker');
            if (!picker) {
                picker = document.createElement('div');
                picker.className = 'reaction-picker';
                reactionEmojis.forEach(emoji => {
                    const span = document.createElement('span');
                    span.textContent = emoji;
                    span.onclick = (e) => {
                        e.stopPropagation();
                        addReactionToMessage(messageId, emoji);
                        picker.classList.remove('active');
                    };
                    picker.appendChild(span);
                });
                msgEl.appendChild(picker);
            }
            picker.classList.toggle('active');
        }
        
        // ============ VOICE MESSAGES ============
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingStartTime = null;
        let recordingTimer = null;
        
        document.getElementById('voiceBtn').addEventListener('mousedown', startRecording);
        document.getElementById('voiceBtn').addEventListener('mouseup', stopRecording);
        document.getElementById('voiceBtn').addEventListener('mouseleave', stopRecording);
        
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                
                mediaRecorder.ondataavailable = (e) => {
                    audioChunks.push(e.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    sendVoiceMessage(audioBlob);
                    stream.getTracks().forEach(track => track.stop());
                };
                
                mediaRecorder.start();
                recordingStartTime = Date.now();
                document.getElementById('voiceBtn').classList.add('recording');
                document.getElementById('recordingIndicator').classList.add('active');
                
                recordingTimer = setInterval(() => {
                    const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                    const mins = Math.floor(elapsed / 60);
                    const secs = elapsed % 60;
                    document.getElementById('recordingTime').textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                }, 1000);
                
            } catch (err) {
                console.error('Microphone access denied:', err);
                addMessage('Microphone access denied. Please allow microphone access.', 'system-message');
            }
        }
        
        function stopRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                document.getElementById('voiceBtn').classList.remove('recording');
                document.getElementById('recordingIndicator').classList.remove('active');
                clearInterval(recordingTimer);
            }
        }
        
        function cancelRecording() {
            if (mediaRecorder && mediaRecorder.state === 'recording') {
                mediaRecorder.stop();
                audioChunks = []; // Clear chunks so nothing gets sent
            }
            document.getElementById('voiceBtn').classList.remove('recording');
            document.getElementById('recordingIndicator').classList.remove('active');
            clearInterval(recordingTimer);
        }
        
        function sendVoiceMessage(audioBlob) {
            if (audioChunks.length === 0) return; // Cancelled
            
            const reader = new FileReader();
            reader.onload = () => {
                const audioData = reader.result;
                const duration = Math.floor((Date.now() - recordingStartTime) / 1000);
                
                if (conn && conn.open) {
                    conn.send({ type: 'voice', data: audioData, duration });
                }
                addVoiceMessage(audioData, duration, 'your-message');
            };
            reader.readAsDataURL(audioBlob);
        }
        
        function addVoiceMessage(audioData, duration, className) {
            const messages = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            messageDiv.dataset.msgId = ++messageIdCounter;
            
            const mins = Math.floor(duration / 60);
            const secs = duration % 60;
            
            messageDiv.innerHTML = `
                <div class="voice-message">
                    <button class="voice-play-btn" onclick="playVoice(this, '${audioData}')">
                        <svg width="16" height="16" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3" fill="white"/></svg>
                    </button>
                    <div class="voice-waveform">${generateWaveform()}</div>
                    <span class="voice-duration">${mins}:${secs.toString().padStart(2, '0')}</span>
                </div>
                <span class="time">${new Date().toLocaleTimeString()}</span>
            `;
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
            
            if (className === 'friend-message') playNotificationSound();
        }
        
        function generateWaveform() {
            let bars = '';
            for (let i = 0; i < 20; i++) {
                const height = Math.random() * 20 + 5;
                bars += `<div class="bar" style="height: ${height}px"></div>`;
            }
            return bars;
        }
        
        function playVoice(btn, audioData) {
            const audio = new Audio(audioData);
            audio.play();
            btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24"><rect x="6" y="4" width="4" height="16" fill="white"/><rect x="14" y="4" width="4" height="16" fill="white"/></svg>';
            audio.onended = () => {
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24"><polygon points="5 3 19 12 5 21 5 3" fill="white"/></svg>';
            };
        }
        
        // ============ REPLY TO MESSAGES ============
        let replyingTo = null;
        
        function replyToMessage(messageId, text, sender) {
            replyingTo = { messageId, text, sender };
            document.getElementById('replyName').textContent = `Replying to ${sender}`;
            document.getElementById('replyText').textContent = text.substring(0, 50) + (text.length > 50 ? '...' : '');
            document.getElementById('replyPreview').classList.add('active');
            document.getElementById('messageInput').focus();
        }
        
        function cancelReply() {
            replyingTo = null;
            document.getElementById('replyPreview').classList.remove('active');
        }
        
        // ============ LINK PREVIEWS ============
        function detectAndFormatLinks(text) {
            const urlRegex = /(https?:\/\/[^\s]+)/g;
            const urls = text.match(urlRegex);
            
            if (urls && urls.length > 0) {
                const url = urls[0];
                const domain = new URL(url).hostname;
                return `
                    <span>${text}</span>
                    <div class="link-preview">
                        <div class="link-preview-title">${domain}</div>
                        <div class="link-preview-description">Click to open link</div>
                        <a href="${url}" target="_blank" class="link-preview-url">${url.substring(0, 40)}...</a>
                    </div>
                `;
            }
            return text;
        }
        
        // ============ BLOCK/MUTE USERS ============
        let blockedUsers = JSON.parse(localStorage.getItem('quickwrap_blocked') || '[]');
        let mutedUsers = JSON.parse(localStorage.getItem('quickwrap_muted') || '[]');
        
        function blockUser(phoneNumber) {
            if (!blockedUsers.includes(phoneNumber)) {
                blockedUsers.push(phoneNumber);
                localStorage.setItem('quickwrap_blocked', JSON.stringify(blockedUsers));
                addMessage(`User ${phoneNumber} has been blocked.`, 'system-message');
            }
        }
        
        function unblockUser(phoneNumber) {
            blockedUsers = blockedUsers.filter(p => p !== phoneNumber);
            localStorage.setItem('quickwrap_blocked', JSON.stringify(blockedUsers));
            addMessage(`User ${phoneNumber} has been unblocked.`, 'system-message');
        }
        
        function muteUser(phoneNumber) {
            if (!mutedUsers.includes(phoneNumber)) {
                mutedUsers.push(phoneNumber);
                localStorage.setItem('quickwrap_muted', JSON.stringify(mutedUsers));
                addMessage(`Notifications muted for ${phoneNumber}.`, 'system-message');
            }
        }
        
        function unmuteUser(phoneNumber) {
            mutedUsers = mutedUsers.filter(p => p !== phoneNumber);
            localStorage.setItem('quickwrap_muted', JSON.stringify(mutedUsers));
            addMessage(`Notifications unmuted for ${phoneNumber}.`, 'system-message');
        }
        
        function isBlocked(phoneNumber) {
            return blockedUsers.includes(phoneNumber);
        }
        
        function isMuted(phoneNumber) {
            return mutedUsers.includes(phoneNumber);
        }
        
        // ============ READ RECEIPTS ============
        function createMessageStatus(status) {
            const checkSvg = `<svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
            
            if (status === 'sent') {
                return `<span class="message-status sent">${checkSvg}</span>`;
            } else if (status === 'delivered') {
                return `<span class="message-status delivered">${checkSvg}${checkSvg.replace('check-icon', 'check-icon double-check')}</span>`;
            } else if (status === 'read') {
                return `<span class="message-status read">${checkSvg}${checkSvg.replace('check-icon', 'check-icon double-check')}</span>`;
            }
            return '';
        }
        
        function sendReadReceipt(messageId) {
            if (conn && conn.open) {
                conn.send({ type: 'read', messageId });
            }
        }
        
        // ============ PROFILE PICTURES ============
        let userProfilePic = localStorage.getItem('quickwrap_profile_pic') || null;
        
        function uploadProfilePic(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                userProfilePic = e.target.result;
                localStorage.setItem('quickwrap_profile_pic', userProfilePic);
                updateProfilePicDisplay();
            };
            reader.readAsDataURL(file);
        }
        
        function updateProfilePicDisplay() {
            const avatar = document.getElementById('userAvatar');
            if (userProfilePic) {
                avatar.style.backgroundImage = `url(${userProfilePic})`;
                avatar.style.backgroundSize = 'cover';
                avatar.textContent = '';
            }
        }
        
        // ============ ENHANCED MESSAGE HANDLING ============
        const originalSetupConnection = setupConnection;
        setupConnection = function() {
            originalSetupConnection.call(this);
            
            if (conn) {
                conn.off('data');
                conn.on('data', (data) => {
                    console.log('Received:', data);
                    
                    // Check if sender is blocked
                    const senderDigits = PhoneData.peerIdToDigits(conn.peer);
                    if (isBlocked(senderDigits)) {
                        console.log('Message from blocked user ignored');
                        return;
                    }
                    
                    if (typeof data === 'object' && data.type) {
                        switch (data.type) {
                            case 'typing':
                                showTypingIndicator(data.isTyping);
                                break;
                            case 'image':
                                addImageMessage(data.data, 'friend-message');
                                break;
                            case 'voice':
                                addVoiceMessage(data.data, data.duration, 'friend-message');
                                break;
                            case 'reaction':
                                addReactionToMessage(data.messageId, data.emoji);
                                break;
                            case 'read':
                                // Update message status to read
                                const msgEl = document.querySelector(`[data-msg-id="${data.messageId}"] .message-status`);
                                if (msgEl) msgEl.className = 'message-status read';
                                break;
                            case 'call-request':
                                showIncomingCall(data.callerName, data.withVideo);
                                break;
                            case 'call-declined':
                                document.getElementById('callStatus').textContent = 'Call declined';
                                setTimeout(() => endCall(false), 2000);
                                break;
                            case 'call-ended':
                                endCall(false);
                                break;
                            case 'message-unsent':
                                // Remove the unsent message from view
                                const unsentMsg = document.querySelector(`[data-msg-id="${data.msgId}"]`);
                                if (unsentMsg) {
                                    unsentMsg.classList.add('unsent');
                                    const unsentSpan = unsentMsg.querySelector('span');
                                    if (unsentSpan) unsentSpan.textContent = 'This message was unsent';
                                }
                                break;
                            case 'message-edited':
                                // Update the edited message
                                const editedMsg = document.querySelector(`[data-msg-id="${data.msgId}"]`);
                                if (editedMsg) {
                                    const textSpan = editedMsg.querySelector('span');
                                    if (textSpan) {
                                        textSpan.innerHTML = data.newText + '<span class="edited-label">(edited)</span>';
                                    }
                                }
                                break;
                            default:
                                addMessage(`Friend: ${JSON.stringify(data)}`, 'friend-message');
                        }
                    } else {
                        addMessage(`Friend: ${data}`, 'friend-message');
                        if (!isMuted(senderDigits)) {
                            playNotificationSound();
                        }
                    }
                });
            }
        };
        
        // Enhanced addMessage with reactions and reply support
        const originalAddMessage = addMessage;
        addMessage = function(text, className = '') {
            const messages = document.getElementById('messages');
            if (!messages) return;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${className}`;
            messageDiv.dataset.msgId = ++messageIdCounter;
            
            if (className === 'system-message') {
                messageDiv.innerHTML = `<div class="system-alert">${text}</div>`;
            } else {
                // Check for reply
                let replyHtml = '';
                if (replyingTo && className === 'your-message') {
                    replyHtml = `
                        <div class="message-reply-quote">
                            <div class="reply-name">${replyingTo.sender}</div>
                            ${replyingTo.text.substring(0, 50)}...
                        </div>
                    `;
                    cancelReply();
                }
                
                // Check for links
                const formattedText = detectAndFormatLinks(text);
                const statusHtml = className === 'your-message' ? createMessageStatus('sent') : '';
                
                messageDiv.innerHTML = `
                    ${replyHtml}
                    <span>${formattedText}</span>
                    <span class="time">${new Date().toLocaleTimeString()}${statusHtml}</span>
                    <div class="message-actions">
                        <button class="msg-action-btn" onclick="showReactionPicker(${messageIdCounter})"></button>
                        <button class="msg-action-btn" onclick="replyToMessage(${messageIdCounter}, '${text.replace(/'/g, "\\'")}', '${className === 'your-message' ? 'You' : 'Friend'}')"></button>
                    </div>
                `;
            }
            
            messages.appendChild(messageDiv);
            messages.scrollTop = messages.scrollHeight;
            
            // Store message
            if (currentChatId && activeChats[currentChatId]) {
                activeChats[currentChatId].messages.push({
                    text, className, time: new Date().toISOString(), msgId: messageIdCounter
                });
                activeChats[currentChatId].lastMessageTime = new Date().toISOString();
                updateChatsList();
            }
        };
        
        // Initialize features
        initEmojiPicker();
        updateProfilePicDisplay();
        
        // ============ VOICE/VIDEO CALL FEATURE ============
        let currentCall = null;
        let localStream = null;
        let callTimer = null;
        let callStartTime = null;
        let callMuted = false;
        let isVideoOff = false;
        let incomingCallData = null;
        let ringtoneAudio = null;
        let callEndProcessed = false;
        
        function startVoiceCall() {
            if (!currentChatId || !activeChats[currentChatId]) {
                addMessage('Select a chat first to make a call.', 'system-message');
                return;
            }
            initiateCall(false);
        }
        
        function startVideoCall() {
            if (!currentChatId || !activeChats[currentChatId]) {
                addMessage('Select a chat first to make a call.', 'system-message');
                return;
            }
            initiateCall(true);
        }
        
        async function initiateCall(withVideo) {
            const chat = activeChats[currentChatId];
            
            try {
                console.log('Initiating call, withVideo:', withVideo);
                
                // Get user media
                const constraints = {
                    audio: true,
                    video: withVideo ? { 
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    } : false
                };
                
                console.log('Requesting media with constraints:', constraints);
                localStream = await navigator.mediaDevices.getUserMedia(constraints);
                console.log('Got local stream:', localStream);
                console.log('Video tracks:', localStream.getVideoTracks());
                console.log('Audio tracks:', localStream.getAudioTracks());
                
                // Show call modal
                document.getElementById('callModal').classList.add('active');
                document.getElementById('callAvatar').textContent = chat.initial;
                document.getElementById('callName').textContent = chat.name;
                document.getElementById('callStatus').textContent = 'Calling...';
                document.getElementById('callTimer').textContent = '00:00';
                callEndProcessed = false;
                
                // Show video elements if video call
                if (withVideo) {
                    const videoContainer = document.getElementById('callVideoContainer');
                    const localVideo = document.getElementById('localVideo');
                    
                    videoContainer.classList.add('active');
                    localVideo.srcObject = localStream;
                    
                    // Ensure video plays
                    localVideo.onloadedmetadata = () => {
                        console.log('Local video metadata loaded');
                        localVideo.play().catch(e => console.log('Local video play error:', e));
                    };
                    
                    document.getElementById('toggleVideoBtn').style.display = 'flex';
                    console.log('Video container activated, local video srcObject set');
                } else {
                    document.getElementById('callVideoContainer').classList.remove('active');
                    document.getElementById('toggleVideoBtn').style.display = 'none';
                }
                
                // Make the call using PeerJS with metadata
                currentCall = peer.call(currentChatId, localStream, {
                    metadata: { withVideo: withVideo }
                });
                
                currentCall.on('stream', (remoteStream) => {
                    document.getElementById('remoteVideo').srcObject = remoteStream;
                    document.getElementById('callStatus').textContent = 'Connected';
                    startCallTimer();
                    playNotificationSound();
                });
                
                currentCall.on('close', () => {
                    endCall();
                });
                
                currentCall.on('error', (err) => {
                    console.error('Call error:', err);
                    document.getElementById('callStatus').textContent = 'Call failed';
                    setTimeout(() => endCall(false), 2000);
                });
                
                // Send call notification via data connection
                if (conn && conn.open) {
                    conn.send({ type: 'call-request', withVideo, callerName: Auth.getCurrentUser() });
                }
                
                // Play ringing sound
                playRingtone();
                
                // Timeout if no answer
                setTimeout(() => {
                    if (document.getElementById('callStatus').textContent === 'Calling...') {
                        document.getElementById('callStatus').textContent = 'No answer';
                        setTimeout(() => endCall(false), 2000);
                    }
                }, 30000);
                
            } catch (err) {
                console.error('Failed to start call:', err);
                addMessage('Failed to access microphone/camera. Please allow permissions.', 'system-message');
            }
        }
        
        function playRingtone() {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const playTone = () => {
                    if (!document.getElementById('callModal').classList.contains('active') && 
                        !document.getElementById('incomingCallModal').classList.contains('active')) return;
                    
                    const osc = audioContext.createOscillator();
                    const gain = audioContext.createGain();
                    osc.connect(gain);
                    gain.connect(audioContext.destination);
                    osc.frequency.value = 440;
                    gain.gain.setValueAtTime(0.2, audioContext.currentTime);
                    gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                    osc.start(audioContext.currentTime);
                    osc.stop(audioContext.currentTime + 0.5);
                    
                    setTimeout(playTone, 2000);
                };
                playTone();
            } catch (e) {
                console.log('Ringtone not supported');
            }
        }
        
        function showIncomingCall(callerName, withVideo) {
            incomingCallData = { callerName, withVideo };
            document.getElementById('incomingCallModal').classList.add('active');
            document.getElementById('incomingCallAvatar').textContent = callerName.charAt(0).toUpperCase();
            document.getElementById('incomingCallName').textContent = callerName;
            document.getElementById('incomingCallType').textContent = withVideo ? 'Video Call' : 'Voice Call';
            callEndProcessed = false;
            playRingtone();
        }
        
        async function acceptCall() {
            document.getElementById('incomingCallModal').classList.remove('active');
            
            if (!incomingCallData) return;
            callEndProcessed = false;
            
            try {
                localStream = await navigator.mediaDevices.getUserMedia({
                    audio: true,
                    video: incomingCallData.withVideo
                });
                
                // Show call modal
                document.getElementById('callModal').classList.add('active');
                document.getElementById('callAvatar').textContent = incomingCallData.callerName.charAt(0).toUpperCase();
                document.getElementById('callName').textContent = incomingCallData.callerName;
                document.getElementById('callStatus').textContent = 'Connected';
                
                if (incomingCallData.withVideo) {
                    document.getElementById('callVideoContainer').classList.add('active');
                    document.getElementById('localVideo').srcObject = localStream;
                    document.getElementById('toggleVideoBtn').style.display = 'flex';
                }
                
                startCallTimer();
                
            } catch (err) {
                console.error('Failed to accept call:', err);
                addMessage('Failed to access microphone/camera.', 'system-message');
            }
        }
        
        function declineCall() {
            document.getElementById('incomingCallModal').classList.remove('active');
            if (conn && conn.open) {
                conn.send({ type: 'call-declined' });
            }
            incomingCallData = null;
        }
        
        function endCall(sendSignal = true) {
            if (callEndProcessed) return;
            callEndProcessed = true;
            // Close call modal
            document.getElementById('callModal').classList.remove('active');
            document.getElementById('incomingCallModal').classList.remove('active');
            
            // Stop local stream
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Close the call
            if (currentCall) {
                currentCall.close();
                currentCall = null;
            }
            
            // Stop timer
            if (callTimer) {
                clearInterval(callTimer);
                callTimer = null;
            }
            
            // Send end call signal
            if (sendSignal && conn && conn.open) {
                conn.send({ type: 'call-ended' });
            }
            
            // Reset video elements
            document.getElementById('remoteVideo').srcObject = null;
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('callVideoContainer').classList.remove('active');
        }
        
        function startCallTimer() {
            callStartTime = Date.now();
            callTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
                const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
                const secs = (elapsed % 60).toString().padStart(2, '0');
                document.getElementById('callTimer').textContent = `${mins}:${secs}`;
            }, 1000);
        }
        
        function toggleMute() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    callMuted = !audioTrack.enabled;
                    document.getElementById('toggleMuteBtn').classList.toggle('active', callMuted);
                }
            }
        }
        
        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    isVideoOff = !videoTrack.enabled;
                    document.getElementById('toggleVideoBtn').classList.toggle('active', isVideoOff);
                }
            }
        }
        
        function toggleSpeaker() {
            // Toggle speaker (mainly for mobile)
            const remoteVideo = document.getElementById('remoteVideo');
            if (remoteVideo.sinkId !== undefined) {
                // Web Audio API speaker selection (limited browser support)
                document.getElementById('toggleSpeakerBtn').classList.toggle('active');
            }
        }
        
        // ============ MESSAGE CONTEXT MENU (EDIT/UNSEND) ============
        let longPressTimer = null;
        let touchStartX = 0;
        let touchStartY = 0;
        
        // Setup message touch/click handlers
        document.getElementById('messages').addEventListener('touchstart', handleMessageTouchStart, { passive: true });
        document.getElementById('messages').addEventListener('touchend', handleMessageTouchEnd);
        document.getElementById('messages').addEventListener('touchmove', handleMessageTouchMove, { passive: true });
        document.getElementById('messages').addEventListener('dblclick', handleMessageDoubleClick);
        document.getElementById('messages').addEventListener('contextmenu', handleMessageContextMenu);
        
        // Close context menu when clicking elsewhere
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.message-context-menu')) {
                closeContextMenu();
            }
        });
        
        function handleMessageTouchStart(e) {
            const message = e.target.closest('.message');
            if (!message || message.classList.contains('system-message')) return;
            
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            
            // Long press detection
            longPressTimer = setTimeout(() => {
                showContextMenu(message, touchStartX, touchStartY);
                // Vibrate if supported
                if (navigator.vibrate) navigator.vibrate(50);
            }, 500);
        }
        
        function handleMessageTouchMove(e) {
            // Cancel long press if user moves finger
            const moveX = Math.abs(e.touches[0].clientX - touchStartX);
            const moveY = Math.abs(e.touches[0].clientY - touchStartY);
            if (moveX > 10 || moveY > 10) {
                clearTimeout(longPressTimer);
            }
        }
        
        function handleMessageTouchEnd(e) {
            clearTimeout(longPressTimer);
        }
        
        function handleMessageDoubleClick(e) {
            const message = e.target.closest('.message');
            if (!message || message.classList.contains('system-message')) return;
            
            e.preventDefault();
            showContextMenu(message, e.clientX, e.clientY);
        }
        
        function handleMessageContextMenu(e) {
            const message = e.target.closest('.message');
            if (!message || message.classList.contains('system-message')) return;
            
            e.preventDefault();
            showContextMenu(message, e.clientX, e.clientY);
        }
        
        function showContextMenu(message, x, y) {
            const menu = document.getElementById('messageContextMenu');
            contextMenuTarget = message;
            contextMenuMsgId = message.dataset.msgId;
            
            // Check if this is user's own message
            const isOwnMessage = message.classList.contains('your-message');
            
            // Show/hide edit and unsend options based on message ownership
            document.getElementById('editMenuItem').style.display = isOwnMessage ? 'flex' : 'none';
            document.getElementById('unsendMenuItem').style.display = isOwnMessage ? 'flex' : 'none';
            
            // Position the menu
            menu.style.left = Math.min(x, window.innerWidth - 180) + 'px';
            menu.style.top = Math.min(y, window.innerHeight - 200) + 'px';
            menu.classList.add('active');
        }
        
        function closeContextMenu() {
            document.getElementById('messageContextMenu').classList.remove('active');
            contextMenuTarget = null;
            contextMenuMsgId = null;
        }
        
        function copyMessage() {
            if (!contextMenuTarget) return;
            
            const textSpan = contextMenuTarget.querySelector('span');
            if (textSpan) {
                const text = textSpan.textContent.replace('(edited)', '').replace('You: ', '').replace('Friend: ', '').trim();
                navigator.clipboard.writeText(text).then(() => {
                    showToast('Message copied to clipboard', 'success');
                });
            }
            closeContextMenu();
        }
        
        function editMessage() {
            if (!contextMenuTarget) {
                showToast('No message selected', 'error');
                return;
            }
            
            const textSpan = contextMenuTarget.querySelector('span');
            if (!textSpan) return;
            
            const currentText = textSpan.textContent.replace('(edited)', '').replace('You: ', '').replace('Friend: ', '').trim();
            const newText = prompt('Edit your message:', currentText);
            
            if (newText && newText.trim() && newText.trim() !== currentText) {
                // Update the message in the UI
                textSpan.innerHTML = 'You: ' + newText.trim() + '<span class="edited-label">(edited)</span>';
                
                // Update in storage - find by msgId or by index
                if (currentChatId && activeChats[currentChatId]) {
                    let msgIndex = -1;
                    
                    if (contextMenuMsgId) {
                        msgIndex = activeChats[currentChatId].messages.findIndex(m => m.msgId === contextMenuMsgId);
                    }
                    
                    // If not found by ID, find by DOM position
                    if (msgIndex === -1) {
                        const allMessages = document.querySelectorAll('#messages .message:not(.system-message)');
                        const msgArray = Array.from(allMessages);
                        const domIndex = msgArray.indexOf(contextMenuTarget);
                        if (domIndex !== -1 && domIndex < activeChats[currentChatId].messages.length) {
                            msgIndex = domIndex;
                        }
                    }
                    
                    if (msgIndex !== -1) {
                        activeChats[currentChatId].messages[msgIndex].text = 'You: ' + newText.trim();
                        activeChats[currentChatId].messages[msgIndex].edited = true;
                        saveChatsToStorage();
                    }
                }
                
                // Notify the other user
                if (conn && conn.open && contextMenuMsgId) {
                    conn.send({ type: 'message-edited', msgId: contextMenuMsgId, newText: 'Friend: ' + newText.trim() });
                }
                
                showToast('Message edited', 'success');
            }
            closeContextMenu();
        }
        
        function unsendMessage() {
            if (!contextMenuTarget) {
                showToast('No message selected', 'error');
                return;
            }
            
            if (confirm('Unsend this message? The other person will see it was unsent.')) {
                // Update the message in the UI
                contextMenuTarget.classList.add('unsent');
                const textSpan = contextMenuTarget.querySelector('span');
                if (textSpan) {
                    textSpan.textContent = 'You unsent this message';
                }
                
                // Update in storage - find by msgId or by index
                if (currentChatId && activeChats[currentChatId]) {
                    let msgIndex = -1;
                    
                    if (contextMenuMsgId) {
                        // Find by msgId
                        msgIndex = activeChats[currentChatId].messages.findIndex(m => m.msgId === contextMenuMsgId);
                    }
                    
                    // If not found by ID, find by DOM position
                    if (msgIndex === -1) {
                        const allMessages = document.querySelectorAll('#messages .message:not(.system-message)');
                        const msgArray = Array.from(allMessages);
                        const domIndex = msgArray.indexOf(contextMenuTarget);
                        if (domIndex !== -1 && domIndex < activeChats[currentChatId].messages.length) {
                            msgIndex = domIndex;
                        }
                    }
                    
                    if (msgIndex !== -1) {
                        activeChats[currentChatId].messages[msgIndex].text = 'Message unsent';
                        activeChats[currentChatId].messages[msgIndex].unsent = true;
                        saveChatsToStorage();
                        console.log('Message unsent at index:', msgIndex);
                    } else {
                        console.error('Could not find message to unsend');
                    }
                }
                
                // Notify the other user
                if (conn && conn.open && contextMenuMsgId) {
                    conn.send({ type: 'message-unsent', msgId: contextMenuMsgId });
                }
                
                showToast('Message unsent', 'success');
            }
            closeContextMenu();
        }
        
        function replyFromContext() {
            if (!contextMenuTarget) return;
            
            const textSpan = contextMenuTarget.querySelector('span');
            if (!textSpan) return;
            
            const text = textSpan.textContent.replace('(edited)', '').trim();
            const isOwnMessage = contextMenuTarget.classList.contains('your-message');
            const sender = isOwnMessage ? 'You' : 'Friend';
            
            replyToMessage(contextMenuMsgId, text, sender);
            closeContextMenu();
        }
    </script>
</body>
</html>